<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SMART SQUAD Invoice">
    <meta name="application-name" content="SMART SQUAD Invoice">
    <meta name="msapplication-TileColor" content="#1a3a5f">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Icons - Updated for better mobile support -->
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="logo.png" color="#1a3a5f">
    
    <!-- Additional PWA icon sizes for better compatibility -->
    <link rel="apple-touch-icon" sizes="57x57" href="logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo.png">
    
    <title>Invoicing System - SMART SQUAD M BUILD PTY LTD</title>
    
    <!-- Favicon -->
    <link rel="icon" href="logo.png" type="image/x-icon">
    
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css?v=1.0.0">
    
    <!-- Include Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js?v=1.0.0"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js?v=1.0.0"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js?v=1.0.0"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js?v=1.0.0"></script>
    
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Include html2canvas for better PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* CSS5 Modern Color Palette for Construction Company */
        :root {
            --primary-color: #1a3a5f; /* Deep blue - professional and trustworthy */
            --secondary-color: #2c5282; /* Medium blue */
            --accent-color: #f97316; /* Construction orange - safety equipment color */
            --accent-light: #fed7aa; /* Light orange for highlights */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --text-lighter: #9ca3af;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border-color: #e5e7eb;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.7);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --error-bg: rgba(239, 68, 68, 0.1);
            --error-border: rgba(239, 68, 68, 0.3);
            --success-bg: rgba(16, 185, 129, 0.1);
            --success-border: rgba(16, 185, 129, 0.3);
            --info-bg: rgba(59, 130, 246, 0.1);
            --info-border: rgba(59, 130, 246, 0.3);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 25px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            /* Font variables for consistent styling */
            --action-font-size: 0.75rem;
            --action-font-weight: 600;
            
            /* Mobile-specific variables */
            --mobile-safe-area-top: env(safe-area-inset-top, 0);
            --mobile-safe-area-bottom: env(safe-area-inset-bottom, 0);
            --mobile-safe-area-left: env(safe-area-inset-left, 0);
            --mobile-safe-area-right: env(safe-area-inset-right, 0);
        }
/* Share dropdown styles */
.share-dropdown {
    position: relative;
    display: inline-block;
}

.share-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-lg);
    min-width: 150px;
    z-index: 1000;
    display: none;
    margin-top: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.share-menu.show {
    display: block;
}

.whatsapp-share {
    color: #25D366;
}

.sms-share {
    color: var(--info-color);
}

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a3a5f 0%, #2c5282 50%, #3182ce 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding: var(--spacing-sm);
            /* Improved mobile compatibility */
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            /* PWA standalone app adjustments */
            padding-top: calc(var(--spacing-sm) + var(--mobile-safe-area-top));
            padding-bottom: calc(var(--spacing-sm) + var(--mobile-safe-area-bottom));
            padding-left: calc(var(--spacing-sm) + var(--mobile-safe-area-left));
            padding-right: calc(var(--spacing-sm) + var(--mobile-safe-area-right));
        }

        /* Standalone PWA adjustments */
        @media all and (display-mode: standalone) {
            body {
                padding-top: calc(var(--spacing-lg) + var(--mobile-safe-area-top));
            }
            
            .app-header {
                padding-top: var(--spacing-lg);
            }
        }

        /* CSS5 Container Query Support */
        @supports (container-type: inline-size) {
            .app-container {
                container-type: inline-size;
            }
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--glass-shadow);
            flex-wrap: wrap;
            gap: var(--spacing-md);
            position: relative;
            overflow: hidden;
        }

        /* CSS5 Decorative Background Pattern */
        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--primary-color));
            background-size: 200% 100%;
            animation: gradient-shift 8s ease infinite;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
        }

        .app-logo img {
            height: 50px;
            width: auto;
            object-fit: contain;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-normal);
        }

        .app-logo img:hover {
            transform: scale(1.05);
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .company-info {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .company-name {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-dark);
        }

        .company-details {
            font-size: 0.7rem;
            color: var(--text-light);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Date and Time Display Styles */
        .date-time-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-md);
            padding: 8px 12px;
            color: var(--text-dark);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .date-time-display:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .current-date {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .current-time {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email-display {
            font-weight: 500;
            color: var(--text-dark);
            padding: 8px 12px;
            background: rgba(26, 58, 95, 0.1);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(26, 58, 95, 0.2);
            font-size: 0.9rem;
        }

        .user-email-display::before {
            content: '\f007';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.9em;
            color: var(--primary-color);
        }

        .logout-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-normal);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .logout-button:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .logout-button:active {
            transform: translateY(0);
        }

        .logout-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .logout-button i {
            font-size: 1em;
        }

        /* Old dropdown styles - keeping for backward compatibility */
        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            z-index: 1000;
            display: none;
            margin-top: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            width: 100%;
            padding: 10px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .dropdown-item:hover {
            background: var(--bg-light);
        }

        .dropdown-divider {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 5px 0;
        }

        .logout-item {
            color: var(--danger-color);
        }

        .logout-item:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .mobile-logout-btn {
            display: none;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .mobile-logout-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.85rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow);
        }

        .action-button:hover::before {
            left: 100%;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }

        /* CSS5 Decorative Card Pattern */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            background-size: 200% 100%;
            animation: gradient-shift 8s ease infinite;
        }

        .form-section h3 {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-md);
            color: var(--text-dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .glass-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-dark);
            font-size: 16px; /* Prevents zoom on iOS */
            transition: all var(--transition-fast);
            font-family: inherit;
            /* Mobile-friendly */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Ensures proper touch target size on all devices */
            min-height: 44px;
        }

        .glass-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 58, 95, 0.1);
            background: white;
        }

        .glass-input:disabled {
            background-color: rgba(229, 231, 235, 0.5);
            cursor: not-allowed;
        }

        /* Responsive size classes that adapt to screen size */
        .large { width: 100%; }
        .small { width: 80px; }
        .xsmall { width: 60px; }

        /* New responsive size classes */
        .medium { 
            width: 100px; 
            min-width: 80px; /* Ensures minimum touch target size */
        }
        .medium-large { 
            width: 120px; 
            min-width: 100px; /* Ensures minimum touch target size */
        }

        /* Mobile-specific adjustments */
        @media (max-width: 768px) {
            .medium { 
                width: 90px; 
                min-width: 70px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            .medium-large { 
                width: 110px; 
                min-width: 90px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            .small { 
                width: 70px; 
                min-width: 60px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .glass-input {
                /* Larger touch targets on mobile */
                min-height: 48px;
                /* More padding for better touch experience */
                padding: 14px 16px;
                /* Better visual feedback on touch */
                transition: all 0.2s ease;
            }
            
            .glass-input:focus {
                transform: scale(1.02);
                box-shadow: 0 0 0 3px rgba(26, 58, 95, 0.2);
            }
            
            /* Adjust date-time display for mobile */
            .date-time-display {
                padding: 6px 10px;
            }
            
            .current-date {
                font-size: 0.8rem;
            }
            
            .current-time {
                font-size: 0.9rem;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .medium { 
                width: 80px; 
                min-width: 60px;
            }
            .medium-large { 
                width: 100px; 
                min-width: 80px;
            }
            .small { 
                width: 60px; 
                min-width: 50px;
            }
        }

        /* Large screens */
        @media (min-width: 1200px) {
            .medium { 
                width: 110px; 
            }
            .medium-large { 
                width: 130px; 
            }
            .small { 
                width: 90px; 
            }
        }

        /* Cross-platform input compatibility */
        input[type="number"] {
            /* Removes spinner controls in Chrome, Safari, Edge, Opera */
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            /* Removes spinner controls in WebKit browsers */
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox specific styling */
        @-moz-document url-prefix() {
            input[type="number"] {
                padding: 12px 16px;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .glass-input {
                /* Prevents zoom on focus */
                font-size: 16px;
                /* Improves touch experience */
                -webkit-appearance: none;
                border-radius: 8px;
            }
        }

        /* Android Chrome specific fixes */
        @media screen and (-webkit-min-device-pixel-ratio: 0) and (min-resolution: .001dpcm) {
            .glass-input {
                /* Better rendering on high DPI screens */
                -webkit-font-smoothing: antialiased;
            }
        }

        /* Classic Dropdown Autocomplete Styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
            z-index: 10;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 100;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            max-height: 200px;
            overflow-y: auto;
            display: none;
            box-shadow: var(--shadow-md);
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-fast);
            font-size: 14px;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: var(--bg-light);
        }

        .autocomplete-item strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Hide the inline suggestion elements */
        .autocomplete-suggestion,
        .autocomplete-accept {
            display: none !important;
        }

        /* Form Layout - Two Column for Desktop */
        .form-layout {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .form-main {
            flex: 3;
        }

        .form-sidebar {
            flex: 2;
        }

        /* Items Section - Integrated into Main Form */
        .items-section {
            margin-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-lg);
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .items-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .items-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .add-item-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.85rem;
            box-shadow: var(--shadow-md);
        }

        .add-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Items Table - Desktop Version */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-md);
            background: white;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .items-table th,
        .items-table td {
            padding: 10px;
            border: none;
            text-align: left;
            font-size: 0.9rem;
        }

        .items-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            /* Added border styling matching GUI color */
            border-bottom: 3px solid var(--accent-color);
        }

        .items-table td {
            border-bottom: 1px solid var(--border-color);
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .remove-item-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all var(--transition-normal);
        }

        .remove-item-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Mobile Items Section - Card View */
        .mobile-items-container {
            display: none;
            margin-top: var(--spacing-md);
        }

        .mobile-item-card {
            background: white;
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .mobile-item-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .mobile-item-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            /* Added border styling matching GUI color */
            border-bottom: 3px solid var(--accent-color);
        }

        .mobile-item-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .mobile-item-expand {
            transition: transform var(--transition-normal);
        }

        .mobile-item-card.expanded .mobile-item-expand {
            transform: rotate(180deg);
        }

        .mobile-item-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
        }

        .mobile-item-card.expanded .mobile-item-content {
            max-height: 500px;
            padding: var(--spacing-md);
        }

        .mobile-item-row {
            display: flex;
            margin-bottom: var(--spacing-md);
            align-items: center;
        }

        .mobile-item-row:last-child {
            margin-bottom: 0;
        }

        .mobile-item-label {
            flex: 0 0 80px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .mobile-item-value {
            flex: 1;
        }

        .mobile-item-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: var(--spacing-md);
        }

        .totals-section {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .totals-container {
            width: 100%;
            text-align: right;
        }

        .payment-details-container {
            width: 100%;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
        }

        .payment-details-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .payment-details-title::before {
            content: '\f51e';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        .payment-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 4px 0;
            font-size: 0.9rem;
        }

        .payment-detail-label {
            font-weight: 600;
            color: var(--text-light);
            min-width: 100px;
        }

        .payment-detail-value {
            font-weight: 500;
            text-align: right;
            flex-grow: 1;
            color: var(--text-dark);
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 6px;
            padding: 6px 0;
        }

        .totals-label {
            font-weight: 600;
            text-align: left;
            color: var(--text-light);
        }

        .totals-value {
            font-weight: 700;
            text-align: right;
            min-width: 80px;
            color: var(--text-dark);
        }

        .document-number-display {
            background: linear-gradient(135deg, rgba(26, 58, 95, 0.1), rgba(44, 82, 130, 0.1));
            border: 2px solid rgba(26, 58, 95, 0.2);
            border-radius: var(--border-radius-md);
            padding: 10px 15px;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .document-number-display i {
            color: var(--primary-color);
        }

        .document-tabs-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--glass-shadow);
        }

        .document-tabs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: 10px;
        }

        .document-tabs-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .document-tabs-title::before {
            content: '\f15b';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--primary-color);
        }

        .tabs-container {
            display: flex;
            margin-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-normal);
            white-space: nowrap;
        }

        .tab-button:hover {
            color: var(--primary-color);
        }

        .tab-button.active {
            color: var(--primary-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .sequence-display {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 15px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .sequence-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .sequence-row:last-child {
            border-bottom: none;
        }

        .sequence-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .sequence-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        /* Simplified Search Bar */
        .search-container {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 0;
            background: transparent;
            color: var(--text-dark);
            font-size: 16px;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-lighter);
        }

        .search-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 16px;
        }

        .search-button:hover {
            background: var(--secondary-color);
        }

        .search-button:active {
            transform: scale(0.98);
        }

        .search-clear {
            background: var(--text-lighter);
            color: white;
            border: none;
            padding: 0 12px;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-clear:hover {
            background: var(--text-light);
        }

        .search-results-info {
            padding: 6px 12px;
            background: var(--bg-light);
            color: var(--text-light);
            font-size: 0.85rem;
            border-radius: var(--border-radius-md);
            margin-bottom: 12px;
        }

        .notification-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 90vw;
        }

        .notification {
            padding: 12px 16px;
            border-radius: var(--border-radius-md);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            font-size: 0.9rem;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

        .error-message, .success-message, .warning-message {
            padding: 10px 12px;
            border-radius: var(--border-radius-md);
            font-size: 0.85rem;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-message { color: var(--danger-color); background: var(--error-bg); border: 1px solid var(--error-border); }
        .success-message { color: var(--success-color); background: var(--success-bg); border: 1px solid var(--success-border); }
        .warning-message { color: var(--warning-color); background: var(--warning-bg); border: 1px solid var(--warning-border); }

        .detail-modal {
            max-width: 95vw;
            width: 90%;
            max-height: 90vh;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .detail-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .detail-section {
            margin-bottom: var(--spacing-md);
            background: var(--bg-light);
            border-radius: var(--border-radius-lg);
            padding: 15px;
            box-shadow: var(--shadow-sm);
        }

        .detail-section h4 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-section h4 i {
            font-size: 0.9rem;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
            padding: 6px 0;
            font-size: 0.9rem;
        }

        .detail-label {
            font-weight: 600;
            width: 120px;
            color: var(--text-light);
        }

        .detail-value {
            flex: 1;
            color: var(--text-dark);
        }

        .detail-items {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .detail-items th,
        .detail-items td {
            padding: 8px;
            border: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.85rem;
        }

        .detail-items th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            /* Added border styling matching GUI color */
            border-bottom: 3px solid var(--accent-color);
        }

        .detail-items tr:nth-child(even) {
            background: var(--bg-light);
        }

        .detail-items tr:hover {
            background: rgba(26, 58, 95, 0.05);
        }

        .detail-items td:last-child {
            text-align: right;
            font-weight: 600;
        }

        .print-only {
            display: none;
        }

        /* Print Styles - Enhanced Professional Version */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body, .print-document {
                margin: 0;
                padding: 0;
                font-family: 'Inter', sans-serif;
                color: #000000;
                background: white;
                width: 210mm;
                height: 297mm;
                box-sizing: border-box;
            }
            
            .print-document {
                padding: 15mm;
                max-width: 190mm;
                margin: auto;
                font-size: 11px;
                line-height: 1.5;
                color: #000000;
                position: relative;
            }
            
            .print-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
            
            .print-logo-section {
                flex: 1;
            }
            
            .print-logo {
                max-width: 140px;
                max-height: 90px;
                object-fit: contain;
                margin-bottom: 10px;
            }
            
            .print-company-name {
                font-family: 'Inter', sans-serif;
                font-size: 18px;
                font-weight: 400; /* Regular weight */
                color: #1a3a5f;
                margin-bottom: 4px;
            }
            
            .print-company-details {
                font-size: 9px;
                color: #000000;
                line-height: 1.4;
            }
            
            .print-company-detail {
                display: block;
                margin-bottom: 2px;
            }
            
            .print-document-info {
                text-align: right;
                min-width: 200px;
            }
            
            .print-document-type {
                font-family: 'Inter', sans-serif;
                font-size: 28px;
                font-weight: 800;
                color: #1a3a5f;
                text-transform: uppercase;
                letter-spacing: 2px;
                margin-bottom: 8px;
            }
            
            .print-document-number {
                font-size: 16px;
                font-weight: 400; /* Regular weight */
                color: #1a3a5f;
                margin-bottom: 4px;
            }
            
            .print-document-date {
                font-size: 10px;
                color: #000000;
            }
            
            .print-addresses {
                display: flex;
                gap: 40px;
                margin-bottom: 25px;
            }
            
            .print-address-block {
                flex: 1;
                padding: 15px;
                background: #f9fafb;
                border-radius: 10px;
                border: 1px solid #e5e7eb;
            }
            
            .print-address-title {
                font-weight: 400; /* Regular weight */
                color: #1a3a5f;
                margin-bottom: 8px;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .print-address-title::before {
                content: '';
                width: 3px;
                height: 12px;
                background: #1a3a5f;
                border-radius: 2px;
            }
            
            .print-address-line {
                font-size: 10px;
                margin-bottom: 3px;
                color: #000000;
            }
            
            .print-address-line strong {
                color: #000000;
                font-weight: 400; /* Regular weight */
            }
            
            /* Replace this entire section in your print styles */
.print-items-section {
    margin-bottom: 25px;
}

.print-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.print-items-table th {
    background: #1a3a5f;
    color: white;
    padding: 10px;
    text-align: left;
    font-weight: 400; /* Regular weight */
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
}

.print-items-table td {
    padding: 8px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 9px;
    vertical-align: top;
    color: #000000;
}

.print-items-table tr:nth-child(even) {
    background: #f9fafb;
}

.print-items-table .description {
    font-weight: 400; /* Regular weight - this is the key fix */
    color: #000000;
    font-size: 10px;
}

.print-items-table .quantity,
.print-items-table .hours {
    text-align: center;
    color: #000000;
    font-weight: 400; /* Regular weight */
}

.print-items-table .rate,
.print-items-table .amount {
    text-align: right;
    font-weight: 400; /* Regular weight */
    color: #000000;
}
            .print-summary {
                display: flex;
                gap: 30px;
                margin-bottom: 25px;
            }
            
            .print-payment-block {
                flex: 1;
                padding: 15px;
                background: #eff6ff;
                border: 1px solid #bfdbfe;
                border-radius: 10px;
                border-left: 3px solid #3b82f6;
            }
            
            .print-payment-title {
                font-weight: 400; /* Regular weight */
                color: #1a3a5f;
                margin-bottom: 8px;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.4px;
            }
            
            .print-payment-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 4px;
                font-size: 9px;
            }
            
            .print-payment-label {
                color: #000000;
                font-weight: 400; /* Regular weight */
            }
            
            .print-payment-value {
                color: #000000;
                font-weight: 400; /* Regular weight */
            }
            
            .print-totals-block {
                width: 280px;
            }
            
            .print-totals-table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .print-totals-table td {
                padding: 8px;
                border-bottom: 1px solid #e5e7eb;
                font-size: 10px;
            }
            
            .print-totals-table .label {
                color: #000000;
                font-weight: 400; /* Regular weight */
            }
            
            .print-totals-table .value {
                text-align: right;
                color: #000000;
                font-weight: 400; /* Regular weight */
            }
            
            .print-totals-table .grand-total td {
                background: #f3f4f6;
                font-weight: 400; /* Regular weight */
                color: #1a3a5f;
                font-size: 11px;
                border-top: 2px solid #1a3a5f;
            }
            
            .print-footer {
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #e5e7eb;
                text-align: center;
                font-size: 9px;
                color: #000000;
                font-style: italic;
            }
            
            /* Hide all non-print elements */
            .app-header, .glass-card, .document-tabs-container, .modal, .notification-container {
                display: none !important;
            }
            
            /* Show only print elements */
            .print-only {
                display: block !important;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 95vw;
            max-height: 95vh;
            overflow-y: auto;
            width: 600px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-normal);
        }

        .modal-close:hover {
            color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .modal-body {
            padding: var(--spacing-md);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: var(--spacing-md);
            border-top: 2px solid var(--border-color);
            background: var(--bg-light);
            flex-wrap: wrap;
        }

        .modal-footer .action-button {
            padding: 8px 16px;
        }

        .glass-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
        }

        .glass-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .table-container {
            overflow-x: auto;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .document-table th,
        .document-table td {
            padding: 10px;
            border: none;
            text-align: left;
            font-size: 0.85rem;
        }

        .document-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            /* Added border styling matching GUI color */
            border-bottom: 3px solid var(--accent-color);
        }

        .document-table td {
            border-bottom: 1px solid var(--border-color);
        }

        .document-table tr:last-child td {
            border-bottom: none;
        }

        .document-table .actions {
            white-space: nowrap;
        }

        .table-action-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            margin: 0 4px;
            font-size: 1rem;
            padding: 6px;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-normal);
        }

        .table-action-btn:hover {
            color: var(--secondary-color);
            background: rgba(26, 58, 95, 0.1);
            transform: scale(1.1);
        }

        .table-action-btn.delete {
            color: var(--danger-color);
        }

        .table-action-btn.delete:hover {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.1);
        }

        .table-action-btn.share {
            color: var(--success-color);
        }

        .table-action-btn.share:hover {
            color: #059669;
            background: rgba(16, 185, 129, 0.1);
        }

        .table-action-btn.sms {
            color: var(--info-color);
        }

        .table-action-btn.sms:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.1);
        }

        .table-action-btn.whatsapp {
            color: #25d366;
        }

        .table-action-btn.whatsapp:hover {
            color: #128c7e;
            background: rgba(37, 211, 102, 0.1);
        }

        .table-action-btn.view {
            color: var(--primary-color);
            /* Using similar font as view details action button */
            font-size: var(--action-font-size);
            font-weight: var(--action-font-weight);
            padding: 4px 8px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-normal);
        }

        .table-action-btn.view:hover {
            color: white;
            background: var(--primary-color);
            transform: scale(1.05);
        }

        /* Apply consistent styling to all table action buttons */
        .table-action-btn.edit,
        .table-action-btn.print {
            color: var(--primary-color);
            font-size: var(--action-font-size);
            font-weight: var(--action-font-weight);
            padding: 4px 8px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-normal);
        }

        .table-action-btn.edit:hover,
        .table-action-btn.print:hover {
            color: white;
            background: var(--primary-color);
            transform: scale(1.05);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius-md);
            padding: 12px 20px;
            font-weight: 600;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .file-upload:hover .file-upload-label {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .logo-preview {
            margin-top: 15px;
            text-align: center;
        }

        .logo-preview img {
            max-width: 200px;
            max-height: 100px;
            object-fit: contain;
            border-radius: var(--border-radius-md);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }

        .auth-modal {
            width: 95%;
            max-width: 420px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .auth-toggle {
            margin-top: 15px;
            text-align: center;
        }

        .auth-toggle a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-links {
            text-align: center;
            margin-top: 10px;
        }

        .forgot-password-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
            color: var(--primary-hover);
        }

        .reset-description {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .success-message {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .mb-4 {
            margin-bottom: var(--spacing-md);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            font-style: italic;
        }

        .share-modal {
            width: 95%;
            max-width: 520px;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .share-option {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            background: white;
        }

        .share-option:hover {
            border-color: var(--primary-color);
            background: rgba(26, 58, 95, 0.05);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .share-option i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .share-option.email i { color: var(--danger-color); }
        .share-option.sms i { color: var(--info-color); }
        .share-option.whatsapp i { color: #25d366; }
        .share-option.download i { color: var(--success-color); }

        .share-option h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        .share-option p {
            margin: 4px 0 0;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .settings-modal {
            width: 95%;
            max-width: 720px;
        }

        .settings-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .settings-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            position: relative;
            transition: all var(--transition-normal);
            white-space: nowrap;
        }

        .settings-tab:hover {
            color: var(--primary-color);
        }

        .settings-tab.active {
            color: var(--primary-color);
        }

        .settings-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px 2px 0 0;
        }

        .settings-content {
            display: none;
        }

        .settings-content.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Mobile Responsive Styles - ENHANCED FOR ALL DEVICES */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-xs);
                /* Enhanced mobile viewport handling */
                height: 100vh;
                overflow-x: hidden;
            }

            .app-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm);
            }
            
            .user-info {
                justify-content: space-between;
                align-items: center;
            }
            
            .mobile-logout-btn {
                display: flex;
            }
            
            .action-buttons {
                display: none;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            
            .form-layout {
                flex-direction: column;
            }
            
            .document-tabs-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-sm);
            }
            
            .table-container {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            .share-options {
                grid-template-columns: 1fr;
            }
            
            .share-modal {
                width: 95vw;
            }
            
            .settings-modal {
                width: 95vw;
            }
            
            /* Mobile items section - card view */
            .items-table {
                display: none;
            }
            
            .mobile-items-container {
                display: block;
            }
            
            .totals-section {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .totals-container, .payment-details-container {
                width: 100%;
            }
            
            .totals-container {
                text-align: left;
            }
            
            .totals-row {
                justify-content: space-between;
            }

            /* Mobile search enhancements */
            .search-container {
                flex-direction: column;
            }

            .search-input {
                padding: 12px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .search-button {
                width: 100%;
                justify-content: center;
                padding: 12px 20px;
            }

            .modal-content {
                width: 95vw;
                margin: 10px;
                max-height: 90vh;
            }

            .modal-header {
                padding: var(--spacing-sm);
            }

            .modal-body {
                padding: var(--spacing-sm);
                max-height: 60vh;
                overflow-y: auto;
            }

            .modal-footer {
                padding: var(--spacing-sm);
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .action-button {
                width: 100%;
                justify-content: center;
            }

            .document-table {
                font-size: 0.75rem;
            }

            .document-table th,
            .document-table td {
                padding: 6px;
            }

            .table-action-btn {
                margin: 0 2px;
                padding: 4px;
            }

            .tabs-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-button {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .settings-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .settings-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            /* Enhanced PWA mobile responsiveness */
            .app-container {
                padding: 0;
                max-width: 100%;
            }

            .glass-card {
                margin: var(--spacing-sm);
                border-radius: var(--border-radius-md);
            }

            .form-section h3 {
                font-size: 1.1rem;
            }

            .items-title {
                font-size: 1.1rem;
            }

            .document-tabs-title {
                font-size: 1.1rem;
            }

            /* Better mobile viewport handling */
            @supports (-webkit-touch-callout: none) {
                body {
                    -webkit-text-size-adjust: 100%;
                }
            }
        }

        /* Enhanced PDF and Print Styles */
        .pdf-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .pdf-preview-container.active {
            display: flex;
        }
        
        .pdf-preview-content {
            background: white;
            width: 95%;
            height: 90%;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }
        
        .pdf-preview-header {
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pdf-preview-body {
            flex: 1;
            overflow: auto;
            padding: 15px;
            background: #f8fafc;
        }
        
        .pdf-preview-actions {
            padding: 12px var(--bg-light);
            display: flex;
            justify-content: center;
            gap: 10px;
            background: var(--bg-light);
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .pdf-canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .pdf-canvas {
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            border-radius: var(--border-radius-md);
            max-width: 100%;
        }
        
        .pdf-page-info {
            text-align: center;
            margin: 10px 0;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .pdf-navigation {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .pdf-nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 8px 12px;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .pdf-nav-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .pdf-nav-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .pdf-page-input {
            width: 50px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 8px;
            font-weight: 600;
        }
        
        .print-template {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-shadow: var(--shadow-lg);
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            color: #000000;
            font-size: 11px;
            line-height: 1.5;
        }
        
        .print-template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
        }
        
        .print-template-logo-section {
            flex: 1;
        }
        
        .print-template-logo {
            max-width: 140px;
            max-height: 90px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        
        .print-template-company-name {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            font-weight: 400; /* Regular weight */
            color: #1a3a5f;
            margin-bottom: 4px;
        }
        
        .print-template-company-details {
            font-size: 9px;
            color: #000000;
            line-height: 1.4;
        }
        
        .print-template-company-detail {
            display: block;
            margin-bottom: 2px;
        }
        
        .print-template-document-info {
            text-align: right;
            min-width: 200px;
        }
        
        .print-template-document-type {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: #1a3a5f;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .print-template-document-number {
            font-size: 16px;
            font-weight: 400; /* Regular weight */
            color: #1a3a5f;
            margin-bottom: 4px;
        }
        
        .print-template-document-date {
            font-size: 10px;
            color: #000000;
        }
        
        .print-template-addresses {
            display: flex;
            gap: 40px;
            margin-bottom: 25px;
        }
        
        .print-template-address-block {
            flex: 1;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .print-template-address-title {
            font-weight: 400; /* Regular weight */
            color: #1a3a5f;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .print-template-address-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: #1a3a5f;
            border-radius: 2px;
        }
        
        .print-template-address-line {
            font-size: 10px;
            margin-bottom: 3px;
            color: #000000;
        }
        
        .print-template-address-line strong {
            color: #000000;
            font-weight: 400; /* Regular weight */
        }
        
        .print-template-items-section {
            margin-bottom: 25px;
        }
        
        .print-template-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .print-template-items-table th {
            background: #1a3a5f;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 400; /* Regular weight */
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        
        .print-template-items-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 9px;
            vertical-align: top;
            color: #000000;
        }
        
        .print-template-items-table tr:nth-child(even) {
            background: #f9fafb;
        }
        
        .print-template-items-table .description {
            font-weight: 400; /* Regular weight */
            color: #000000;
            font-size: 10px;
        }
        
        .print-template-items-table .quantity,
        .print-template-items-table .hours {
            text-align: center;
            color: #000000;
            font-weight: 400; /* Regular weight */
        }
        
        .print-template-items-table .rate,
        .print-template-items-table .amount {
            text-align: right;
            font-weight: 400; /* Regular weight */
            color: #000000;
        }
        
        .print-template-summary {
            display: flex;
            gap: 30px;
            margin-bottom: 25px;
        }
        
        .print-template-payment-block {
            flex: 1;
            padding: 15px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            border-left: 3px solid #3b82f6;
        }
        
        .print-template-payment-title {
            font-weight: 400; /* Regular weight */
            color: #1a3a5f;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        
        .print-template-payment-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 9px;
        }
        
        .print-template-payment-label {
            color: #000000;
            font-weight: 400; /* Regular weight */
        }
        
        .print-template-payment-value {
            color: #000000;
            font-weight: 400; /* Regular weight */
        }
        
        .print-template-totals-block {
            width: 280px;
        }
        
        .print-template-totals-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .print-template-totals-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 10px;
        }
        
        .print-template-totals-table .label {
            color: #000000;
            font-weight: 400; /* Regular weight */
        }
        
        .print-template-totals-table .value {
            text-align: right;
            color: #000000;
            font-weight: 400; /* Regular weight */
        }
        
        .print-template-totals-table .grand-total td {
            background: #f3f4f6;
            font-weight: 400; /* Regular weight */
            color: #1a3a5f;
            font-size: 11px;
            border-top: 2px solid #1a3a5f;
        }
        
        .print-template-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            font-size: 9px;
            color: #000000;
            font-style: italic;
        }

        /* Login page logo */
        .auth-logo {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .auth-logo img {
            height: 50px;
            width: auto;
            object-fit: contain;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
        }

        /* Remember me checkbox */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .remember-me input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .remember-me label {
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        /* Autocomplete keyboard shortcut hint - REMOVED */
        .autocomplete-hint {
            display: none; /* Hide the keyboard shortcut hint */
        }

        /* Install PWA Banner */
        .pwa-install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10002;
            max-width: 90vw;
            animation: slideUp 0.5s ease;
        }

        .pwa-install-banner.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .pwa-install-banner .icon {
            font-size: 1.5rem;
        }

        .pwa-install-banner .text {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .pwa-install-banner .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background var(--transition-fast);
        }

        .pwa-install-banner .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .pwa-install-banner .install-btn {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .pwa-install-banner .install-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        /* Image attachment styles */
        .image-attachment {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .image-info {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .remove-image {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all var(--transition-normal);
        }

        .remove-image:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Offline Status Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning-color);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            z-index: 10001;
            display: none;
            transform: translateY(-100%);
            transition: transform var(--transition-normal);
        }

        .offline-indicator.show {
            display: block;
            transform: translateY(0);
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--info-color);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideInUp 0.3s ease;
        }

        .sync-indicator.show {
            display: flex;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .sync-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* Pending Sync Badge */
        .pending-sync-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--warning-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: var(--shadow-md);
        }

        .sync-status {
            position: relative;
            display: inline-block;
        }

    </style>
</head>
<body>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Offline Status Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> You are currently offline. Data will be saved locally and synced when you're back online.
    </div>

    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <div class="sync-spinner"></div>
        <span>Syncing data...</span>
    </div>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <i class="fas fa-download icon"></i>
        <span class="text">Install this app on your device for quick access!</span>
        <button class="install-btn" id="pwaInstallBtn">Install</button>
        <button class="close" id="pwaCloseBtn">&times;</button>
    </div>

    <!-- Auth Modal -->
    <div class="modal active" id="authModal">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h3 class="modal-title">Authentication</h3>
            </div>
            <div class="modal-body">
                <div class="auth-logo">
                    <img src="logo.png" alt="Company Logo">
                </div>
                <form id="authForm" class="auth-form" autocomplete="off">
                    <input type="email" id="authEmail" class="glass-input" placeholder="Email" required autocomplete="off">
                    <input type="password" id="authPassword" class="glass-input" placeholder="Password" required autocomplete="off">
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Remember username and password</label>
                    </div>
                    <button type="submit" class="action-button glass-button" id="authSubmitBtn">
                        <i class="fas fa-sign-in-alt"></i> <span id="authButtonText">Login</span>
                    </button>
                    <div class="auth-links">
                        <a href="#" id="forgotPasswordLink" class="forgot-password-link">Forgot your password?</a>
                    </div>
                    <div id="authEmailError" class="error-message" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal" style="display: none;">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h3 class="modal-title">Reset Password</h3>
                <button class="modal-close" id="closeForgotPasswordModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-logo">
                    <img src="logo.png" alt="Company Logo">
                </div>
                <p class="reset-description">Enter your email address and we'll send you a link to reset your password.</p>
                <form id="forgotPasswordForm" class="auth-form">
                    <input type="email" id="resetEmail" class="glass-input" placeholder="Enter your email" required>
                    <button type="submit" class="action-button glass-button" id="resetSubmitBtn">
                        <i class="fas fa-paper-plane"></i> Send Reset Link
                    </button>
                    <div class="auth-links">
                        <a href="#" id="backToLoginLink" class="forgot-password-link">Back to Login</a>
                    </div>
                    <div id="resetEmailError" class="error-message" style="display: none;"></div>
                    <div id="resetEmailSuccess" class="success-message" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div class="app-container" id="appContainer" style="display: none;">

        <!-- App Header -->
        <div class="app-header">
            <div class="app-logo" id="appLogo">
                <img src="logo.png" alt="Company Logo">
                <div>
                    <h2 class="app-title">Invoicing System</h2>
                    <div class="company-info" id="companyInfoHeader">
                        <div class="company-name">SMART SQUAD M BUILD PTY LTD</div>
                        <div class="company-details">ABN 14 670 018 069 | Mobile: 0470136187</div>
                    </div>
                </div>
            </div>
            
            <!-- Date and Time Display -->
            <div class="date-time-display" id="dateTimeDisplay">
                <div class="current-date" id="currentDate"></div>
                <div class="current-time" id="currentTime"></div>
            </div>
            
            <div class="user-info">
                <div class="user-email-display" id="userEmail">user@example.com</div>
                <button class="logout-button" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Create New Document Section -->
        <div class="glass-card" id="invoiceFormCard">
            <h3 class="mb-4">Create New Document</h3>

            <div class="form-layout">
                <div class="form-main">
                    <div class="form-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="documentType" class="form-label">Document Type</label>
                                <select id="documentType" class="glass-input">
                                    <option value="Invoice">Invoice</option>
                                    <option value="Quote">Quote</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="documentNumber" class="form-label">Document Number</label>
                                <div class="document-number-display">
                                    <i class="fas fa-hashtag"></i>
                                    <span id="documentNumber">AUTO-GENERATED</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="documentDate" class="form-label">Date</label>
                                <input type="date" id="documentDate" class="glass-input" required>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="clientName" class="form-label">Client Name</label>
                                <input type="text" id="clientName" class="glass-input" placeholder="John Smith" required>
                            </div>
                            <div class="form-group">
                                <label for="companyName" class="form-label">Company Name</label>
                                <input type="text" id="companyName" class="glass-input" placeholder="ABC Pty Ltd">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="clientEmail" class="form-label">Email</label>
                                <input type="email" id="clientEmail" class="glass-input" placeholder="john@example.com">
                            </div>
                            <div class="form-group">
                                <label for="clientMobile" class="form-label">Mobile</label>
                                <input type="tel" id="clientMobile" class="glass-input" placeholder="0412 345 678">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="jobAddress" class="form-label">Job Address</label>
                            <input type="text" id="jobAddress" class="glass-input" placeholder="123 Main St, City, Country">
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="jobNumber" class="form-label">Job Number</label>
                                <input type="text" id="jobNumber" class="glass-input" placeholder="e.g., JOB-001">
                            </div>
                            <div class="form-group">
                                <label for="workOrder" class="form-label">Work Order</label>
                                <input type="text" id="workOrder" class="glass-input" placeholder="e.g., WO-001">
                            </div>
                        </div>
                        
                        <!-- Items Section - Integrated into Main Form -->
                        <div class="items-section">
                            <div class="items-header">
                                <h3 class="items-title">Items</h3>
                                <button type="button" class="add-item-btn" id="addItem">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                            
                            <!-- Desktop Items Table -->
                            <table class="items-table" id="itemsTable">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Hours</th>
                                        <th>Rate ($)</th>
                                        <th>Amount ($)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <tr class="item-row">
                                        <td>
                                            <div class="autocomplete-container">
                                                <input type="text" class="glass-input large item-description" required autocomplete="off">
                                                <div class="autocomplete-suggestion"></div>
                                                <button class="autocomplete-accept" style="display: none;">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td><input type="number" class="glass-input medium item-quantity" value="1" min="0" step="1"></td>
                                        <td><input type="number" class="glass-input medium item-hours" value="0" min="0" step="0.5"></td>
                                        <td><input type="number" class="glass-input medium-large item-rate" value="0.00" min="0" step="0.01" required></td>
                                        <td><input type="text" class="glass-input small item-amount" value="0.00" readonly></td>
                                        <td><button type="button" class="glass-button remove-item"><i class="fas fa-trash"></i></button></td>
                                        <!-- Hidden input for image data -->
                                        <input type="hidden" class="item-image">
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Mobile Items Container -->
                            <div class="mobile-items-container" id="mobileItemsContainer">
                                <!-- Mobile item cards will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-sidebar">
                    <div class="form-section">
                        <div class="form-group">
                            <label for="bankName" class="form-label">Bank Name</label>
                            <input type="text" id="bankName" class="glass-input" placeholder="e.g., Commonwealth Bank">
                        </div>
                        <div class="form-group">
                            <label for="bsb" class="form-label">Bank BSB</label>
                            <input type="text" id="bsb" class="glass-input" placeholder="e.g., 083214">
                        </div>
                        <div class="form-group">
                            <label for="account" class="form-label">Account Number</label>
                            <input type="text" id="account" class="glass-input" placeholder="e.g., 709739590">
                        </div>
                        <div class="form-group">
                            <label for="accountName" class="form-label">Account Name</label>
                            <input type="text" id="accountName" class="glass-input" value="SMART SQUAD M BUILD PTY LTD" disabled>
                        </div>
                    </div>

                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="totals-row">
                                <div class="totals-label">Subtotal:</div>
                                <div class="totals-value" id="subtotal">$0.00</div>
                            </div>
                            <div class="totals-row">
                                <div class="totals-label">GST (10%):</div>
                                <div class="totals-value" id="gst">$0.00</div>
                            </div>
                            <div class="totals-row">
                                <div class="totals-label">Total:</div>
                                <div class="totals-value" id="total">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="payment-details-container">
                        <div class="payment-details-title">Payment Details</div>
                        <div class="payment-detail-row">
                            <span class="payment-detail-label">Bank:</span>
                            <span class="payment-detail-value" id="bankNameDisplay">-</span>
                        </div>
                        <div class="payment-detail-row">
                            <span class="payment-detail-label">BSB:</span>
                            <span class="payment-detail-value" id="bsbDisplay">-</span>
                        </div>
                        <div class="payment-detail-row">
                            <span class="payment-detail-label">Account:</span>
                            <span class="payment-detail-value" id="accountDisplay">-</span>
                        </div>
                        <div class="payment-detail-row">
                            <span class="payment-detail-label">Account Name:</span>
                            <span class="payment-detail-value" id="accountNameDisplay">SMART SQUAD M BUILD PTY LTD</span>
                        </div>
                        <button type="button" class="action-button glass-button" id="clearPaymentDetails" style="margin-top: 10px;">
                            <i class="fas fa-times"></i> Clear Payment Details
                        </button>
                    </div>
                </div>
            </div>

            <div style="margin-top: var(--spacing-md); display: flex; flex-wrap: wrap; gap: 8px;">
                <button class="action-button glass-button" id="saveButton">
                    <i class="fas fa-save"></i> <span id="saveButtonText">Save</span>
                </button>
                <button class="action-button glass-button" id="cancelForm">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="action-button glass-button" id="printPdfButton">
                    <i class="fas fa-print"></i> Print PDF
                </button>
                <button class="action-button glass-button" id="emailButton">
                    <i class="fas fa-envelope"></i> Email
                </button>
            </div>
        </div>

        <!-- Document Management Section -->
        <div class="glass-card document-tabs-container">
            <div class="document-tabs-header">
                <h3 class="document-tabs-title">Documents</h3>
                <div class="sequence-display">
                    <div class="sequence-row">
                        <div class="sequence-label">Next Invoice Number:</div>
                        <div class="sequence-value" id="nextInvNumber">INV-00255</div>
                    </div>
                    <div class="sequence-row">
                        <div class="sequence-label">Next Quote Number:</div>
                        <div class="sequence-value" id="nextQotNumber">QOT-00288</div>
                    </div>
                </div>
                <div class="sync-status">
                    <div id="pendingSyncCount" class="pending-sync-badge" style="display: none;">0</div>
                </div>
            </div>

            <div class="tabs-container">
                <button class="tab-button active" id="invoicesTab">Invoices</button>
                <button class="tab-button" id="quotationsTab">Quotations</button>
            </div>

            <div class="tab-content active" id="invoicesContent">
                <div class="search-container" id="invoiceSearchContainer">
                    <input type="text" class="search-input" id="searchInvoices" placeholder="Search invoices by number, client, date, or amount...">
                    <button class="search-button" id="searchInvoicesBtn">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="search-clear" id="clearInvoicesSearch" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="search-results-info" id="invoiceSearchResults" style="display: none;"></div>
                <div class="table-container">
                    <table class="document-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Number</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <tr><td colspan="6" class="loading-message">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="quotationsContent">
                <div class="search-container" id="quotationSearchContainer">
                    <input type="text" class="search-input" id="searchQuotations" placeholder="Search quotations by number, client, date, or amount...">
                    <button class="search-button" id="searchQuotationsBtn">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="search-clear" id="clearQuotationsSearch" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="search-results-info" id="quotationSearchResults" style="display: none;"></div>
                <div class="table-container">
                    <table class="document-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Number</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="quotationsTableBody">
                            <tr><td colspan="6" class="loading-message">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Print Version -->
    <div class="print-only" id="printVersion">
    </div>

    <!-- Document Detail Modal -->
    <div class="modal" id="documentDetailModal">
        <div class="modal-content detail-modal">
            <div class="modal-header">
                <h3 class="modal-title detail-title" id="detailModalTitle">Document Details</h3>
                <button class="modal-close" id="closeDetailModal">&times;</button>
            </div>
            <div class="modal-body" id="detailModalBody">
            </div>
            <div class="modal-footer">
                <button class="action-button glass-button" id="printDetailBtn">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="action-button glass-button" id="closeDetailModalFooter">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
<div class="modal" id="shareModal">
  <div class="modal-content share-modal">
    <div class="modal-header">
      <h3 class="modal-title">Share Document</h3>
      <button class="modal-close" id="closeShareModal">&times;</button>
    </div>
    <div class="modal-body">
      <p>Choose how you'd like to share this document:</p>
      <div class="share-options">

        <!-- Existing Download PDF -->
        <div class="share-option download" id="shareDownload">
          <i class="fas fa-download"></i>
          <h4>Download PDF</h4>
          <p>Save PDF to device</p>
        </div>

       <!-- New WhatsApp Option -->
<div class="share-option whatsapp" id="shareWhatsapp" tabindex="0" style="cursor:pointer;">
    <i class="fab fa-whatsapp"></i>
    <h4>WhatsApp</h4>
    <p>Send invoice via WhatsApp</p>
</div>

<!-- New SMS Option -->
<div class="share-option sms" id="shareSMS" tabindex="0" style="cursor:pointer;">
    <i class="fas fa-sms"></i>
    <h4>SMS</h4>
    <p>Send invoice via SMS</p>
</div>

<!-- New Email Option -->
<div class="share-option email" id="shareEmail" tabindex="0" style="cursor:pointer;">
    <i class="fas fa-envelope"></i>
    <h4>Email</h4>
    <p>Send invoice via Email</p>
</div>

<div class="modal-footer">
                <button class="action-button glass-button" id="closeShareModalFooter">
                    Close
                </button>
            </div>
      </div>
    </div>
  </div>
</div>

            

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" id="companyTab">Company Details</button>
                    <button class="settings-tab" id="bankTab">Bank Details</button>
                    <button class="settings-tab" id="appearanceTab">Appearance</button>
                </div>
                
                <div class="settings-content active" id="companyContent">
                    <div class="settings-section">
                        <h4>Company Information</h4>
                        <form class="settings-form" id="companyForm">
                            <div class="form-group">
                                <label for="settingsCompanyName" class="form-label">Company Name</label>
                                <input type="text" id="settingsCompanyName" class="glass-input" value="SMART SQUAD M BUILD PTY LTD">
                            </div>
                            <div class="form-group">
                                <label for="settingsCompanyABN" class="form-label">ABN</label>
                                <input type="text" id="settingsCompanyABN" class="glass-input" value="14 670 018 069">
                            </div>
                            <div class="form-group">
                                <label for="settingsCompanyEmail" class="form-label">Email</label>
                                <input type="email" id="settingsCompanyEmail" class="glass-input" value="smartsquad.m23@gmail.com">
                            </div>
                            <div class="form-group">
                                <label for="settingsCompanyPhone" class="form-label">Phone</label>
                                <input type="tel" id="settingsCompanyPhone" class="glass-input" value="0470 136 187">
                            </div>
                            <div class="form-group">
                                <label for="settingsCompanyAddress" class="form-label">Address</label>
                                <input type="text" id="settingsCompanyAddress" class="glass-input" value="">
                            </div>
                            <div class="form-group">
                                <label for="settingsCompanyWebsite" class="form-label">Website</label>
                                <input type="url" id="settingsCompanyWebsite" class="glass-input" placeholder="https://example.com">
                            </div>
                        </form>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Company Logo</h4>
                        <div class="file-upload">
                            <input type="file" id="logoUpload" accept="image/*">
                            <label for="logoUpload" class="file-upload-label">
                                <i class="fas fa-upload"></i> Upload New Logo
                            </label>
                        </div>
                        <div class="logo-preview">
                            <img id="logoPreview" src="logo.png" alt="Company Logo">
                        </div>
                    </div>
                </div>
                
                <div class="settings-content" id="bankContent">
                    <div class="settings-section">
                        <h4>Bank Information</h4>
                        <form class="settings-form" id="bankForm">
                            <div class="form-group">
                                <label for="settingsBankName" class="form-label">Bank Name</label>
                                <input type="text" id="settingsBankName" class="glass-input" placeholder="e.g., Commonwealth Bank">
                            </div>
                            <div class="form-group">
                                <label for="settingsBankBSB" class="form-label">BSB</label>
                                <input type="text" id="settingsBankBSB" class="glass-input" placeholder="e.g., 083214">
                            </div>
                            <div class="form-group">
                                <label for="settingsBankAccount" class="form-label">Account Number</label>
                                <input type="text" id="settingsBankAccount" class="glass-input" placeholder="e.g., 709739590">
                            </div>
                            <div class="form-group">
                                <label for="settingsBankAccountName" class="form-label">Account Name</label>
                                <input type="text" id="settingsBankAccountName" class="glass-input" value="SMART SQUAD M BUILD PTY LTD" disabled>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="settings-content" id="appearanceContent">
                    <div class="settings-section">
                        <h4>Color Theme</h4>
                        <form class="settings-form" id="appearanceForm">
                            <div class="form-group">
                                <label for="settingsPrimaryColor" class="form-label">Primary Color</label>
                                <input type="color" id="settingsPrimaryColor" class="glass-input" value="#1a3a5f">
                            </div>
                            <div class="form-group">
                                <label for="settingsSecondaryColor" class="form-label">Secondary Color</label>
                                <input type="color" id="settingsSecondaryColor" class="glass-input" value="#2c5282">
                            </div>
                            <div class="form-group">
                                <label for="settingsAccentColor" class="form-label">Accent Color</label>
                                <input type="color" id="settingsAccentColor" class="glass-input" value="#f97316">
                            </div>
                        </form>
                    </div>
                    
                    <div class="settings-section">
                        <h4>PDF Settings</h4>
                        <form class="settings-form" id="pdfForm">
                            <div class="form-group">
                                <label for="settingsPdfFooter" class="form-label">PDF Footer Text</label>
                                <input type="text" id="settingsPdfFooter" class="glass-input" value="Thank you for your business!">
                            </div>
                            <div class="form-group">
                                <label for="settingsPdfTerms" class="form-label">Payment Terms</label>
                                <textarea id="settingsPdfTerms" class="glass-input" rows="4" placeholder="Payment terms...">Payment due within 14 days. Late payments may incur interest at 5% per month.</textarea>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="action-button glass-button" id="saveSettings">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                    <button class="action-button glass-button" id="resetSettings">
                        <i class="fas fa-undo"></i> Reset to Default
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD25CHzARM-J37ydB_86qk57tku6-WKjcc",
          authDomain: "inovice-f82ef.firebaseapp.com",
          projectId: "inovice-f82ef",
          storageBucket: "inovice-f82ef.firebasestorage.app",
          messagingSenderId: "877125697453",
          appId: "1:877125697453:web:67cef8e0ecac8fc6c52b24"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        const ALLOWED_UID = "aoSHGmN7TyOs4eLzJUwSRKmwaIO2";
        let currentUser = null;
        let companyInfo = {
            name: "SMART SQUAD M BUILD PTY LTD",
            abn: "14 670 018 069",
            email: "smartsquad.m23@gmail.com",
            phone: "0470 136 187",
            address: "",
            website: ""
        };
        let bankInfo = {
            name: "",
            bsb: "",
            account: "",
            accountName: "SMART SQUAD M BUILD PTY LTD"
        };
        let appearanceSettings = {
            primaryColor: "#1a3a5f",
            secondaryColor: "#2c5282",
            accentColor: "#f97316",
            pdfFooter: "Thank you for your business!",
            pdfTerms: "Payment due within 14 days. Late payments may incur interest at 5% per month."
        };
        let userSequences = { nextInvNumber: 255, nextQotNumber: 288 }; // Updated starting numbers
        let logoData = "logo.png";
        let editingDocId = null;
        let firebaseInitialized = false;
        let authRetryCount = 0;
        const MAX_AUTH_RETRIES = 3;
        let currentDocumentForShare = null;
        let allDocuments = [];
        let pdfDoc = null;
        let currentPage = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        
        // Store original form values for cancel functionality
        let originalFormValues = {};

        // Offline functionality variables
        let isOnline = navigator.onLine;
        let dbInstance = null;
        let pendingSyncCount = 0;
        let syncInProgress = false;

        // PWA Service Worker Registration
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Check if we're running on HTTPS or localhost
                const isHttps = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                
                if (isHttps || isLocalhost) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('SW registered: ', registration);
                        })
                        .catch(registrationError => {
                            console.log('SW registration failed: ', registrationError);
                        });
                } else {
                    console.log('Service Worker not registered: Must be served over HTTPS or from localhost');
                }
            });
        }

        // Conditionally load manifest to avoid CORS issues with file:// protocol
        if (location.protocol !== 'file:') {
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (!manifestLink) {
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = './site.webmanifest';
                document.head.appendChild(link);
            }
        } else {
            // Remove manifest link if it exists when using file:// protocol
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                manifestLink.remove();
            }
        }
// Add this function to handle sharing
async function shareViaWhatsApp(id, type) {
    try {
        const docRef = db.collection(type + 's').doc(id);
        const doc = await docRef.get();
        
        if (!doc.exists) {
            showNotification(`${type} not found`, 'error');
            return;
        }
        
        const data = doc.data();
        const message = buildShareMessage(data, type);
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        document.querySelectorAll('.share-menu').forEach(menu => {
            menu.classList.remove('show');
        });
        
        showNotification(`Opening WhatsApp to share ${type}`, 'info');
    } catch (error) {
        showNotification(`Error sharing ${type} via WhatsApp: ${error.message}`, 'error');
    }
}

async function shareViaSMS(id, type) {
    try {
        const docRef = db.collection(type + 's').doc(id);
        const doc = await docRef.get();
        
        if (!doc.exists) {
            showNotification(`${type} not found`, 'error');
            return;
        }
        
        const data = doc.data();
        const message = buildShareMessage(data, type);
        const clientPhone = data.clientPhone || '';
        const smsUrl = `sms:${clientPhone}?body=${encodeURIComponent(message)}`;
        window.open(smsUrl, '_blank');
        
        document.querySelectorAll('.share-menu').forEach(menu => {
            menu.classList.remove('show');
        });
        
        showNotification(`Opening SMS to share ${type}`, 'info');
    } catch (error) {
        showNotification(`Error sharing ${type} via SMS: ${error.message}`, 'error');
    }
}

function buildShareMessage(data, type) {
    const companyName = companyInfo.name || 'SMART SQUAD M BUILD PTY LTD';
    const documentNumber = data.number || 'N/A';
    const clientName = data.billTo?.name || data.clientName || 'Client';
    const totalAmount = data.total || data.totalAmount || '0.00';
    const documentDate = data.date ? formatDate(data.date) : 'N/A';
    
    let message = `${type.charAt(0).toUpperCase() + type.slice(1)} from ${companyName}\n`;
    message += `${type.charAt(0).toUpperCase() + type.slice(1)} Number: ${documentNumber}\n`;
    message += `Date: ${documentDate}\n`;
    message += `Client: ${clientName}\n`;
    message += `Total Amount: $${typeof totalAmount === 'number' ? totalAmount.toFixed(2) : totalAmount}\n`;
    
    if (type === 'invoice' && data.dueDate) {
        message += `Due Date: ${formatDate(data.dueDate)}\n`;
    }
    
    message += `\nThank you for your business!\n`;
    message += `\n${companyName}`;
    
    // Add contact info if available
    if (companyInfo.phone) {
        message += `\nPhone: ${companyInfo.phone}`;
    }
    if (companyInfo.email) {
        message += `\nEmail: ${companyInfo.email}`;
    }
    
    return message;
}

// Utility function to format dates
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // Return original if invalid
        
        // Format as DD/MM/YYYY
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
    } catch (error) {
        console.error('Error formatting date:', error);
        return dateString;
    }
}
        // Initialize IndexedDB for offline storage
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('InvoiceAppDB', 1);
                
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    console.log('IndexedDB initialized successfully');
                    resolve(dbInstance);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object stores for different data types
                    if (!db.objectStoreNames.contains('documents')) {
                        const documentStore = db.createObjectStore('documents', { keyPath: 'id' });
                        documentStore.createIndex('type', 'type', { unique: false });
                        documentStore.createIndex('date', 'date', { unique: false });
                        documentStore.createIndex('syncStatus', 'syncStatus', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    if (!db.objectStoreNames.contains('sequences')) {
                        const sequencesStore = db.createObjectStore('sequences', { keyPath: 'key' });
                    }
                    
                    console.log('IndexedDB schema created');
                };
            });
        }

 function saveDocumentToIndexedDB(documentData, isUpdate = false) {
    return new Promise((resolve, reject) => {
        if (!dbInstance) {
            reject(new Error('IndexedDB not initialized'));
            return;
        }

        // Ensure the document has an ID, even for updates
        let documentWithSyncStatus = { ...documentData };
        if (!documentWithSyncStatus.id) {
            // Generate a temporary ID if missing
            documentWithSyncStatus.id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Add sync status
        documentWithSyncStatus = {
            ...documentWithSyncStatus,
            syncStatus: isOnline ? 'synced' : 'pending',
            lastModified: new Date().toISOString()
        };

        const transaction = dbInstance.transaction(['documents'], 'readwrite');
        const store = transaction.objectStore('documents');

        const request = isUpdate ? store.put(documentWithSyncStatus) : store.add(documentWithSyncStatus);

        request.onsuccess = () => {
            console.log(isUpdate ? 'Document updated in IndexedDB' : 'Document saved to IndexedDB');
            resolve(documentWithSyncStatus);
        };
        request.onerror = (event) => {
            console.error(`Error ${isUpdate ? 'updating' : 'saving'} document in IndexedDB:`, event.target.error);
            reject(event.target.error);
        };

        transaction.oncomplete = () => {
            if (!isOnline) {
                updatePendingSyncCount();
            }
        };
    });
}

        // Get documents from IndexedDB
        function getDocumentsFromIndexedDB(type = null) {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['documents'], 'readonly');
                const store = transaction.objectStore('documents');
                
                let documents = [];
                
                if (type) {
                    const index = store.index('type');
                    const request = index.getAll(type);
                    
                    request.onsuccess = () => {
                        documents = request.result;
                        resolve(documents);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error getting documents from IndexedDB:', event.target.error);
                        reject(event.target.error);
                    };
                } else {
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        documents = request.result;
                        resolve(documents);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error getting documents from IndexedDB:', event.target.error);
                        reject(event.target.error);
                    };
                }
            });
        }

        // Get pending documents that need to be synced
        function getPendingDocuments() {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['documents'], 'readonly');
                const store = transaction.objectStore('documents');
                const index = store.index('syncStatus');
                const request = index.getAll('pending');
                
                request.onsuccess = () => {
                    const pendingDocs = request.result;
                    resolve(pendingDocs);
                };
                
                request.onerror = (event) => {
                    console.error('Error getting pending documents:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Update sync status of a document
        function updateDocumentSyncStatus(documentId, status) {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['documents'], 'readwrite');
                const store = transaction.objectStore('documents');
                
                const getRequest = store.get(documentId);
                getRequest.onsuccess = () => {
                    const document = getRequest.result;
                    if (document) {
                        document.syncStatus = status;
                        document.lastModified = new Date().toISOString();
                        
                        const updateRequest = store.put(document);
                        updateRequest.onsuccess = () => {
                            resolve(document);
                        };
                        
                        updateRequest.onerror = (event) => {
                            console.error('Error updating document sync status:', event.target.error);
                            reject(event.target.error);
                        };
                    } else {
                        reject(new Error('Document not found'));
                    }
                };
                
                getRequest.onerror = (event) => {
                    console.error('Error getting document for sync status update:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Save settings to IndexedDB
        function saveSettingsToIndexedDB(settings) {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                
                const request = store.put({
                    key: 'userSettings',
                    value: settings,
                    lastModified: new Date().toISOString()
                });
                
                request.onsuccess = () => {
                    console.log('Settings saved to IndexedDB');
                    resolve(settings);
                };
                
                request.onerror = (event) => {
                    console.error('Error saving settings to IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Get settings from IndexedDB
        function getSettingsFromIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                
                const request = store.get('userSettings');
                
                request.onsuccess = () => {
                    const settings = request.result ? request.result.value : null;
                    resolve(settings);
                };
                
                request.onerror = (event) => {
                    console.error('Error getting settings from IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Save sequences to IndexedDB
        function saveSequencesToIndexedDB(sequences) {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['sequences'], 'readwrite');
                const store = transaction.objectStore('sequences');
                
                const request = store.put({
                    key: 'userSequences',
                    value: sequences,
                    lastModified: new Date().toISOString()
                });
                
                request.onsuccess = () => {
                    console.log('Sequences saved to IndexedDB');
                    resolve(sequences);
                };
                
                request.onerror = (event) => {
                    console.error('Error saving sequences to IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Get sequences from IndexedDB
        function getSequencesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!dbInstance) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = dbInstance.transaction(['sequences'], 'readonly');
                const store = transaction.objectStore('sequences');
                
                const request = store.get('userSequences');
                
                request.onsuccess = () => {
                    const sequences = request.result ? request.result.value : { nextInvNumber: 255, nextQotNumber: 288 };
                    resolve(sequences);
                };
                
                request.onerror = (event) => {
                    console.error('Error getting sequences from IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Update pending sync count
        async function updatePendingSyncCount() {
            try {
                const pendingDocs = await getPendingDocuments();
                pendingSyncCount = pendingDocs.length;
                
                const badge = document.getElementById('pendingSyncCount');
                if (pendingSyncCount > 0) {
                    badge.textContent = pendingSyncCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating pending sync count:', error);
            }
        }

        // Sync pending documents with Firebase
        async function syncPendingDocuments() {
            if (!isOnline || syncInProgress || !currentUser) {
                return;
            }
            
            syncInProgress = true;
            showSyncIndicator();
            
            try {
                const pendingDocs = await getPendingDocuments();
                
                if (pendingDocs.length === 0) {
                    hideSyncIndicator();
                    syncInProgress = false;
                    return;
                }
                
                console.log(`Syncing ${pendingDocs.length} pending documents...`);
                
                for (const doc of pendingDocs) {
                    try {
                        // Remove syncStatus and lastModified before sending to Firebase
                        const { syncStatus, lastModified, ...firebaseDoc } = doc;
                        
                        if (doc.id.startsWith('temp_')) {
                            // This is a new document, create it in Firebase
                            firebaseDoc.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            firebaseDoc.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                            
                            const docRef = await db.collection('quotes').add(firebaseDoc);
                            
                            // Update the document in IndexedDB with the new Firebase ID
                            const transaction = dbInstance.transaction(['documents'], 'readwrite');
                            const store = transaction.objectStore('documents');
                            
                            // Delete the temp document
                            store.delete(doc.id);
                            
                            // Add the new document with the Firebase ID
                            const syncedDoc = {
                                ...firebaseDoc,
                                id: docRef.id,
                                syncStatus: 'synced',
                                lastModified: new Date().toISOString()
                            };
                            
                            store.put(syncedDoc);
                            
                            console.log(`Created new document in Firebase with ID: ${docRef.id}`);
                        } else {
                            // This is an existing document, update it in Firebase
                            firebaseDoc.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                            
                            await db.collection('quotes').doc(doc.id).update(firebaseDoc);
                            
                            // Update the sync status in IndexedDB
                            await updateDocumentSyncStatus(doc.id, 'synced');
                            
                            console.log(`Updated document in Firebase with ID: ${doc.id}`);
                        }
                    } catch (error) {
                        console.error(`Error syncing document ${doc.id}:`, error);
                        // Continue with other documents even if one fails
                    }
                }
                
                // Refresh the document list
                await loadDocuments();
                
                // Update the pending sync count
                await updatePendingSyncCount();
                
                showNotification('All documents synced successfully!', 'success');
            } catch (error) {
                console.error('Error during sync:', error);
                showNotification('Error syncing documents. Please try again.', 'error');
            } finally {
                hideSyncIndicator();
                syncInProgress = false;
            }
        }

        // Show sync indicator
        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('show');
        }

        // Hide sync indicator
        function hideSyncIndicator() {
            document.getElementById('syncIndicator').classList.remove('show');
        }

        // Show offline indicator
        function showOfflineIndicator() {
            document.getElementById('offlineIndicator').classList.add('show');
        }

        // Hide offline indicator
        function hideOfflineIndicator() {
            document.getElementById('offlineIndicator').classList.remove('show');
        }

        // Handle online/offline events
        window.addEventListener('online', () => {
            isOnline = true;
            hideOfflineIndicator();
            showNotification('You are back online!', 'success');
            
            // Try to sync pending documents
            if (currentUser) {
                syncPendingDocuments();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            showOfflineIndicator();
            showNotification('You are currently offline. Data will be saved locally.', 'warning');
        });

        // PWA Install Prompt
        let deferredPrompt;
        let installBannerShown = false;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner after 3 seconds
            setTimeout(() => {
                if (!installBannerShown && !localStorage.getItem('pwa-install-dismissed')) {
                    showPWAInstallBanner();
                }
            }, 3000);
        });

        function showPWAInstallBanner() {
            const banner = document.getElementById('pwaInstallBanner');
            banner.classList.add('show');
            installBannerShown = true;
        }

        const pwaInstallBtnElement = document.getElementById('pwaInstallBtn');
        if (pwaInstallBtnElement) {
            pwaInstallBtnElement.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    hidePWAInstallBanner();
                }
            });
        }

        const pwaCloseBtnElement = document.getElementById('pwaCloseBtn');
        if (pwaCloseBtnElement) {
            pwaCloseBtnElement.addEventListener('click', () => {
                hidePWAInstallBanner();
                localStorage.setItem('pwa-install-dismissed', 'true');
            });
        }

        function hidePWAInstallBanner() {
            const banner = document.getElementById('pwaInstallBanner');
            banner.classList.remove('show');
        }

        // Detect if device is mobile with enhanced detection
        function isMobileDevice() {
            // More comprehensive mobile detection
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // Check for common mobile indicators
            const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i;
            
            // Check for touch capability
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
            
            // Check for small screen
            const isSmallScreen = window.innerWidth <= 768;
            
            // Check for mobile orientation
            const hasOrientation = typeof window.orientation !== 'undefined';
            
            // Check for reduced pointer precision (common on touch devices)
            const hasCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
            
            // Check for hover capability (mobile devices typically don't have hover)
            const noHover = window.matchMedia('(hover: none)').matches;
            
            // Return true if any mobile indicators are detected
            return mobileRegex.test(userAgent) || hasTouch || isSmallScreen || hasOrientation || hasCoarsePointer || noHover;
        }

        // Enhanced autocomplete data with categories
        const autocompleteData = {
            
  "labour": [
    "Labour", "Labour charge", "Labour per person", "Labour per hour", "Labour per day",
    "Person", "Person per hour", "Person per day", "Skilled labour", "Unskilled labour",
    "Supervisor", "Foreman", "Project manager", "Site manager", "Team leader",
    "1 Person Labour", "2 Persons Labour", "3 Persons Labour", "4 Persons Labour", "5 Persons Labour",
    "6 Persons Labour", "7 Persons Labour", "8 Persons Labour", "9 Persons Labour", "10 Persons Labour"
  ],
  "drywall": [
    "Drywall installation", "Drywall repair", "Drywall patching", "Drywall finishing",
    "Patching", "Taping", "Mudding", "Skim coating", "Texture application", "Texture repair",
    "Installation", "Stopping", "Screeding", "Plastering", "Plaster repair", "Ceiling repair",
    "Cornice installation", "Archway construction", "Bulkhead installation", "Soundproofing",
    "Hang drywall", "Tape and joint drywall", "Drywall mudding", "Corner bead installation",
    "Patch gaps between walls and ceilings", "Replaster damaged sections", "Decorative plaster molding",
    "Venetian plaster finish", "Dot and dab plasterboard fixing", "Render external walls",
    "Level uneven walls", "Apply finishing plaster", "Sand plaster surface"
  ],
  "carpentry": [
    "Carpentry", "Installation", "Trim work", "Cabinet installation", "Shelving installation",
    "Door installation", "Window installation", "Framing", "Deck installation", "Fence installation",
    "Crown molding", "Baseboard", "Casing", "Staircase installation", "Handrail installation",
    "Install crown molding", "Fit door frames", "Adjust or replace hinges", "Repair rotten window sills",
    "Replace broken glass pane", "Mount shelves and cabinets", "Assemble flat-pack furniture",
    "Weatherstrip doors and windows", "Install soffit and fascia", "Gutter cleaning and repair",
    "Deck staining or sealing", "Fence installation or repair", "Patch drywall holes",
    "Install grab bars", "Secure loose handrails", "Replace door knobs/locks", "Soundproof room treatment",
    "Install underfloor heating mats", "Acoustic panel installation", "Hang ceiling grid",
    "Refinish wooden doors", "Re-glaze windows", "Install pull-down attic ladder",
    "Repair warped window frames", "Replace broken roller blinds", "Install retractable awnings",
    "Fit energy-efficient window inserts", "Repair damaged soffit vents", "Replace worn door sweeps",
    "Fit child safety locks", "Install pet doors", "Fit magnetic screen doors", "Install stair runners",
    "Replace broken mailbox posts", "Re-secure loose banisters", "Install security storm doors",
    "Repair split eaves", "Replace broken roof tiles", "Install emergency exit window",
    "Fit insulated garage doors", "Repair damaged fascia boards", "Replace broken step treads",
    "Install retractable clotheslines", "Repair broken gate hinges", "Fit roll-up garage screens",
    "Repair damaged lattice panels", "Replace broken patio umbrella stands", "Fit cabinet door soft-close mechanisms",
    "Install under-stair storage drawers", "Repair broken window stops", "Replace broken outlet covers",
    "Fit magnetic knife strips", "Install folding workbench", "Repair broken ceiling medallions",
    "Replace broken switch actuators", "Fit smart thermostats", "Install solar attic vents",
    "Repair broken railing spindles", "Replace broken patio door rollers", "Fit automatic gate openers",
    "Install compost bins", "Repair broken window track", "Replace broken shelf pins",
    "Fit over-the-door organizers", "Install foldable chair", "Repair broken ceiling vent damper",
    "Replace broken dimmer knob", "Fit wall-mounted magazine rack", "Install outdoor movie screen",
    "Repair broken ceiling fan downrod", "Replace broken shower head", "Fit wall-mounted ski rack",
    "Install solar pathway lights", "Repair broken door jamb", "Replace broken hinge pin",
    "Fit magnetic spice racks", "Install portable dishwasher", "Repair broken floor tile edge",
    "Replace broken outlet terminal", "Fit over-door coat hanger", "Install foldable lawn chair",
    "Repair broken ceiling vent damper spring", "Replace broken dimmer knob insert washer",
    "Fit wall-mounted tandem bike rack", "Install solar-powered veranda string lights", "Repair broken window screen spline delamination",
    "Replace broken light fixture pivot screw", "Fit under-cabinet toothbrush holder", "Install foldable therapy chair",
    "Repair broken ceiling fan blade bracket screw", "Replace broken shower handle set screw washer",
    "Fit wall-mounted tricycle rack", "Install solar-powered deck string lights", "Repair broken door jamb cracking",
    "Replace broken dimmer knob insert sleeve", "Fit magnetic tool organizer panel", "Install portable smoothie maker",
    "Repair broken floor tile corner", "Replace broken outlet terminal screw washer", "Fit over-door shoe organizer",
    "Install foldable chair", "Repair broken ceiling vent damper spring clip", "Replace broken dimmer knob insert sleeve washer",
    "Fit wall-mounted surfboard rack", "Install solar-powered landscape spotlight"
  ],
  "painting": [
    "Primer application", "Finish coating", "Texture painting", "Faux finishing", "Wallpaper",
    "Sanding", "Scraping", "Power washing", "Epoxy flooring", "Concrete staining",
    "Prime and paint walls", "Repair peeling paint on trim", "Re-stain wooden decking",
    "Refinish wooden doors", "Paint exterior siding", "Spray painting", "Roller application",
    "Brush detailing", "Ceiling painting", "Accent wall painting", "Color matching",
    "Wall preparation", "Masking", "Paint removal", "Stain sealing", "Clear coat application"
  ],
  "services": [
    "Deck service", "Service call", "Blind installation", "Gutter installation", "TV mounting",
    "Demolition", "Excavation", "Foundation work", "Concrete work", "Masonry",
    "Roofing", "Siding", "Insulation", "HVAC", "Plumbing", "Landscaping",
    "Emergency repair", "After hours service", "Response", "Water damage restoration",
    "Fire damage restoration", "Storm damage repair", "Seasonal maintenance", "Winterization",
    "Summer preparation", "Spring cleanup", "Fall maintenance", "Holiday lighting",
    "Snow removal", "Leaf removal", "Consultation", "Estimate", "Quotation", "Advice",
    "Planning", "Design", "Project management", "Site supervision", "Permit application",
    "Inspection report", "As-built drawings", "Project documentation", "Reporting",
    "Record keeping", "Billing", "Compliance", "Inspection", "Testing", "Certification",
    "Approval", "Code compliance", "Safety inspection", "Accessibility compliance",
    "Soil testing", "Concrete testing", "Asbestos testing", "Lead testing",
    "Environmental remediation", "Abatement", "Cleanup", "Disposal", "Hazardous material",
    "Contamination removal", "Soil remediation", "Water treatment", "Temporary structure",
    "Shoring", "Bracing", "Scaffolding", "Barriers", "Temporary power", "Temporary water",
    "Site facilities", "Equipment installation", "Equipment maintenance", "Equipment operation",
    "Equipment repair", "Machinery setup", "Tool rental"
  ],
  "plumbing": [
    "Plumbing repair", "Toilet installation", "Shower installation", "Bathroom renovation",
    "Skylight installation", "Ventilation system", "Gutter cleaning", "Roof coating",
    "Install bathroom sink", "Replace toilet", "Fix leaking faucet", "Unclog drain",
    "Install water heater", "Pipe freezing repair", "Sewer line inspection", "PVC pipe cutting and gluing",
    "Copper pipe soldering", "PEX tubing installation", "Install shower valve", "Bathtub fitting",
    "Water pressure regulator setup", "Sump pump installation", "Grease trap installation",
    "Backflow prevention device", "Drain-waste-vent (DWV) system work", "Toilet flange repair",
    "Water shut-off valve replacement", "Gas line connection for appliances", "Re-pipe entire house",
    "Drain camera inspection", "Hydro jetting", "Water filtration system installation",
    "Tankless water heater installation", "Under-sink plumbing repair", "Garbage disposal repair",
    "Leak detection", "Water meter replacement", "Fixture replacement", "Valve adjustment"
  ],
  "concrete": [
    "Concrete pouring", "Concrete finishing", "Concrete repair", "Foundation", "Slab",
    "Patio", "Driveway", "Sidewalk", "Stamped concrete", "Stained concrete",
    "Concrete cutting", "Concrete leveling", "Concrete sealing", "Pour footings",
    "Formwork", "Rebar installation", "Control joint cutting", "Curing", "Polished concrete",
    "Exposed aggregate", "Concrete overlay", "Self-leveling compound", "Concrete resurfacing",
    "Crack injection", "Epoxy crack sealing", "Concrete demolition", "Edge repair",
    "Spalling repair", "Efflorescence treatment"
  ],
  "excavation": [
    "Excavation", "Digging", "Trenching", "Grading", "Landscaping", "Site preparation",
    "Earthmoving", "Backfilling", "Compaction", "Drainage excavation", "Basement excavation",
    "Utility trenching", "Topsoil removal", "Rock excavation", "Dewatering", "Site clearing",
    "Cut and fill", "Slope stabilization", "French drain installation", "Septic tank excavation"
  ],
  "structural": [
    "Framing", "Steel erection", "Structural repair", "Beam installation", "Column installation",
    "Joist installation", "Load bearing wall", "Structural inspection", "Foundation repair",
    "Install load-bearing wall", "Frame interior walls", "Build stud partition walls",
    "Reinforce floor joists", "Install roof trusses", "Concrete slab pouring", "Steel beam installation",
    "Demolish non-load-bearing wall", "Structural brickwork", "Underpinning", "Cantilever construction",
    "Framing for extensions", "Timber frame construction", "Column installation",
    "Scaffolding erection", "Temporary shoring", "Structural steel welding", "Floor leveling",
    "Repair sagging floors", "Rebuild chimney crown", "Repair retaining walls", "Replace rotted wood trim"
  ],
  "hvac": [
    "HVAC installation", "Heating system", "Cooling system", "Ventilation", "Ductwork",
    "Air conditioning", "Furnace installation", "Heat pump", "Thermostat", "Air purification",
    "Duct cleaning", "HVAC repair", "HVAC maintenance", "Install exhaust fans",
    "Ventilation system", "Attic ventilation fan", "HRV/ERV system", "Zoning system",
    "Air quality testing", "Filter replacement", "Refrigerant recharge", "Duct sealing"
  ],
  "flooring": [
    "Flooring installation", "Carpet", "Laminate", "Hardwood", "Vinyl", "Tile installation",
    "Floor repair", "Subfloor", "Underlayment", "Floor refinishing", "Floor leveling",
    "Fit laminate or vinyl flooring", "Replace broken floor tiles", "Re-lay damaged driveway pavers",
    "Install backsplash", "Grout tile surfaces", "Re-grout bathroom tiles", "Clean and seal grout lines",
    "Re-caulk bathtub surround", "Install heated towel rail", "Replace cracked skylight glazing",
    "Install radiant barriers", "Soundproof flooring", "Floating floor installation",
    "Engineered wood installation", "Carpet stretching", "Tile leveling system",
    "Moisture barrier under flooring", "Adhesive flooring application"
  ],
  "electrical": [
    "Electrical installation", "Wiring", "Outlet installation", "Switch installation",
    "Lighting installation", "Ceiling fan", "Electrical panel", "GFCI installation", "Doorbell installation",
    "Appliance installation", "Wiring", "Circuit installation", "Data cabling", "Security system",
    "Home automation", "LED lighting", "Emergency lighting", "Outdoor lighting",
    "Install light fixtures", "Wire new outlets", "Circuit breaker panel upgrade", "Run electrical conduit",
    "Install recessed lighting", "Wire ceiling fans", "Add dedicated circuits", "Conduit bending and fitting",
    "Junction box installation", "Troubleshoot short circuits", "Test continuity and voltage",
    "Install dimmer switches", "Underground cable trenching", "Smoke detector wiring",
    "Thermostat wiring", "Rewire outdated circuits", "Install surge protectors",
    "Low-voltage wiring", "Solar panel wiring", "EV charger installation", "Generator hookup"
  ],
  "cleanup": [
    "Site cleanup", "Post construction cleanup", "Final cleanup", "Debris removal",
    "Junk removal", "Rubbish removal", "Pressure washing", "Window cleaning", "Carpet cleaning",
    "Waste disposal", "Recycling", "Hazardous material removal", "Clean gutters",
    "Power wash exterior surfaces", "Remove construction debris", "Dispose of old fixtures",
    "Clean up after renovation", "Interior dust removal", "Job site organization"
  ],
  "maintenance": [
    "Seasonal maintenance", "Winterization", "Summer preparation", "Spring cleanup",
    "Fall maintenance", "Holiday lighting", "Snow removal", "Leaf removal",
    "Preventive maintenance", "Building maintenance", "Equipment maintenance", "System maintenance",
    "Servicing", "Upkeep", "Restoration", "Routine inspection", "Filter changes", "Lubrication",
    "Component replacement", "System calibration", "Performance testing"
  ],
  "compliance": [
    "Compliance", "Inspection", "Testing", "Certification", "Approval",
    "Code compliance", "Safety inspection", "Accessibility compliance"
  ],
  "rooms": [
    "Bathroom", "Kitchen", "Bedroom", "Living room", "Dining room", "Hallway",
    "Corridor", "Staircase", "Balcony", "Terrace", "Veranda", "Porch", "Entry",
    "Foyer", "Lobby", "Office", "Storage", "Closet", "Wardrobe", "Laundry"
  ],
  "testing": [
    "Soil testing", "Concrete testing", "Asbestos testing", "Lead testing"
  ],
  "repair": [
    "Maintenance", "Repair", "Servicing", "Upkeep", "Restoration", "Preventive maintenance",
    "Building maintenance", "Equipment maintenance", "System maintenance"
  ],
  "heavy": [
    "Welding", "Cutting", "Boring", "Drilling", "Piling", "Blasting", "Dredging",
    "Tunneling", "Underground utilities", "Pipeline installation", "Heavy machinery operation",
    "Crane operation", "Demolition with explosives", "Core drilling", "Anchor bolting",
    "Structural steel fabrication", "Rebar tying", "Shotcrete application", "Micropiling"
  ],
  "finishing": [
    "Finishing", "Trim", "Molding", "Crown molding", "Baseboard", "Casing",
    "Final touches", "Detail work", "Custom finishes", "Apply final coats", "Touch-up painting",
    "Seal edges", "Install trim", "Finish carpentry", "Polish surfaces", "Buff flooring",
    "Caulk gaps and joints", "Re-caulk perimeter of house", "Sealant application around windows"
  ],
  "utility": [
    "Utility", "Gas line", "Electrical", "Water line", "Sewer line", "Telecommunications",
    "Utility installation", "Utility repair", "Utility locating", "Meter installation",
    "Service line connection", "Utility shutoff", "Pipe bursting", "Cable pulling",
    "Line tapping", "Service drop installation", "Conduit installation"
  ],
  "environmental": [
    "Environmental remediation", "Abatement", "Cleanup", "Disposal", "Hazardous material",
    "Contamination removal", "Soil remediation", "Water treatment", "Asbestos removal",
    "Mold remediation", "Lead paint abatement", "Chemical spill cleanup", "Biohazard cleanup"
  ],
  "temporary": [
    "Temporary structure", "Shoring", "Bracing", "Scaffolding", "Barriers",
    "Temporary power", "Temporary water", "Site facilities", "Portable toilets",
    "Temporary fencing", "Construction trailers", "Mobile offices", "Dust containment",
    "Noise barriers", "Weather protection tents"
  ],
  "equipment": [
    "Equipment installation", "Equipment maintenance", "Equipment operation",
    "Equipment repair", "Machinery setup", "Tool rental", "Calibration", "Commissioning",
    "Decommissioning", "Operator training", "Preventive servicing", "Diagnostic testing"
  ],
  "documentation": [
    "Documentation", "Reporting", "Record keeping", "Billing", "Permit application",
    "Inspection report", "As-built drawings", "Project documentation", "Change orders",
    "Work logs", "Time tracking", "Material invoices", "Contract management"
  ],
  "consulting": [
    "Consultation", "Estimate", "Quotation", "Advice", "Planning", "Design",
    "Project management", "Site supervision", "Feasibility study", "Value engineering",
    "Cost analysis", "Schedule optimization", "Risk assessment", "Regulatory guidance"
  ],
  "emergency": [
    "Emergency repair", "Service call", "Response", "After hours service",
    "Water damage restoration", "Fire damage restoration", "Storm damage repair",
    "Immediate leak repair", "Power outage response", "Gas leak emergency",
    "Broken pipe burst", "Downed tree removal", "Structural instability check"
  ]

        };

        // Flatten all categories into a single array for searching
        const flattenedAutocompleteData = Object.values(autocompleteData).flat();

        // Initialize Firebase
        async function initializeFirebase() {
            if (firebaseInitialized) {
                console.log("Firebase already initialized");
                checkAuthState();
                return;
            }

            try {
                if (firebase.apps.length === 0) {
                    console.log("Initializing new Firebase app");
                    firebase.initializeApp(firebaseConfig);
                } else {
                    console.log("Using existing Firebase app instance");
                }

                const app = firebase.app();
                const firestore = app.firestore();
                
                firebaseInitialized = true;
                console.log("Firebase initialized successfully");
                checkAuthState();
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                
                try {
                    const app = firebase.app();
                    const firestore = app.firestore();
                    
                    firebaseInitialized = true;
                    console.log("Firebase initialized with minimal method");
                    checkAuthState();
                    
                } catch (fallbackError) {
                    console.error("Minimal initialization also failed:", fallbackError);
                    showNotification("Error connecting to database. Please refresh the page.", "error");
                }
            }
        }

        // Check authentication state
        function checkAuthState() {
            if (!firebaseInitialized) {
                console.log("Firebase not initialized yet, skipping auth check");
                return;
            }

            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed, user:', user && user.uid ? user.uid : user);
                if (user && user.uid === ALLOWED_UID) {
                    console.log('Detected allowed admin UID. Setting currentUser.');
                    currentUser = user;
                    document.getElementById('userEmail').textContent = user.email;
                    authRetryCount = 0;
                    
                    // Initialize IndexedDB
                    try {
                        await initIndexedDB();
                        
                        // Load data from IndexedDB first (for faster UI)
                        await loadUserSequencesFromIndexedDB();
                        await loadUserSettingsFromIndexedDB();
                        
                        // Then try to sync with Firebase if online
                        if (isOnline) {
                            await loadUserSettings();
                            await loadUserSequences();
                            await syncPendingDocuments();
                        }
                        
                        initializeApp();
                    } catch (error) {
                        console.error("Error initializing IndexedDB:", error);
                        showNotification("Error initializing offline storage. Some features may not work properly.", "warning");
                        
                        // Fallback to Firebase-only mode
                        await loadUserSettings();
                        await loadUserSequences();
                        initializeApp();
                    }
                } else if (user) {
                    console.error(`Access denied for user: ${user.email} (UID: ${user.uid}). Expected UID: ${ALLOWED_UID}`);
                    await auth.signOut();
                    showNotification(`Access denied. You are not authorized to use this system. User UID: ${user.uid}`, "error");
                    showAuthModal();
                } else {
                    currentUser = null;
                    document.getElementById('appContainer').style.display = 'none';
                    showAuthModal();
                }
            }, (error) => {
                console.error("Auth state change error:", error);
                if (authRetryCount < MAX_AUTH_RETRIES) {
                    authRetryCount++;
                    console.log(`Retrying auth check (${authRetryCount}/${MAX_AUTH_RETRIES})`);
                    setTimeout(checkAuthState, 1000 * authRetryCount);
                } else {
                    showNotification("Authentication error. Please refresh the page.", "error");
                }
            });
        }

        // Load user settings from IndexedDB
        async function loadUserSettingsFromIndexedDB() {
            try {
                const settings = await getSettingsFromIndexedDB();
                if (settings) {
                    companyInfo = settings.companyInfo || companyInfo;
                    bankInfo = settings.bankInfo || bankInfo;
                    appearanceSettings = settings.appearanceSettings || appearanceSettings;
                    logoData = settings.logoData || logoData;
                    
                    updateCompanyInfoHeader();
                    updateHeaderLogo(logoData);
                    populateSettingsForm();
                    updatePaymentDetailsDisplay();
                    applyAppearanceSettings();
                    
                    console.log("Loaded settings from IndexedDB");
                }
            } catch (error) {
                console.error("Error loading settings from IndexedDB:", error);
            }
        }

        // Load user sequences from IndexedDB
        async function loadUserSequencesFromIndexedDB() {
            try {
                const sequences = await getSequencesFromIndexedDB();
                if (sequences) {
                    userSequences = sequences;
                    updateSequenceDisplay();
                    updateDocumentNumberDisplay();
                    
                    console.log("Loaded sequences from IndexedDB");
                }
            } catch (error) {
                console.error("Error loading sequences from IndexedDB:", error);
            }
        }

        // Initialize the main application
        function initializeApp() {
            document.getElementById('appContainer').style.display = 'block';
            const authModal = document.getElementById('authModal');
            authModal.style.display = 'none';
            authModal.classList.remove('active');
            
            // Show/hide offline indicator based on current status
            if (isOnline) {
                hideOfflineIndicator();
            } else {
                showOfflineIndicator();
            }
            
            updateCompanyInfoHeader();
            updateHeaderLogo(logoData);
            loadDocuments();
            setupEventListeners();
            
            // Initialize autocomplete for existing description fields
            initializeAllAutocompletes();
            
            updateDocumentNumberDisplay();
            setupDropdownMenu();
            setupTabs();
            setupSimpleSearch();
            setupSettingsModal();
            
            // Initialize mobile items if on mobile
            if (isMobileDevice()) {
                initializeMobileItems();
            }
            
            // Store original form values for cancel functionality
            storeOriginalFormValues();
            
            // Initialize date and time display
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Update pending sync count
            updatePendingSyncCount();
        }

        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            
            // Format date
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            };
            const dateString = now.toLocaleDateString('en-US', options);
            
            // Format time
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            };
            const timeString = now.toLocaleTimeString('en-US', timeOptions);
            
            // Update DOM
            document.getElementById('currentDate').textContent = dateString;
            document.getElementById('currentTime').textContent = timeString;
        }

        // Store original form values for cancel functionality
        function storeOriginalFormValues() {
            originalFormValues = {
                documentType: document.getElementById('documentType').value,
                documentDate: document.getElementById('documentDate').value,
                clientName: document.getElementById('clientName').value,
                companyName: document.getElementById('companyName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientMobile: document.getElementById('clientMobile').value,
                jobAddress: document.getElementById('jobAddress').value,
                jobNumber: document.getElementById('jobNumber').value,
                workOrder: document.getElementById('workOrder').value,
                bankName: document.getElementById('bankName').value,
                bsb: document.getElementById('bsb').value,
                account: document.getElementById('account').value,
                accountName: document.getElementById('accountName').value
            };
            
            // Store items
            originalFormValues.items = [];
            
            if (isMobileDevice()) {
                // Mobile version
                const itemCards = document.querySelectorAll('.mobile-item-card');
                itemCards.forEach(card => {
                    originalFormValues.items.push({
                        description: card.querySelector('.item-description').value,
                        quantity: card.querySelector('.item-quantity').value,
                        hours: card.querySelector('.item-hours').value,
                        rate: card.querySelector('.item-rate').value,
                        amount: card.querySelector('.item-amount').value
                    });
                });
            } else {
                // Desktop version
                const itemRows = document.querySelectorAll('.item-row');
                itemRows.forEach(row => {
                    originalFormValues.items.push({
                        description: row.querySelector('.item-description').value,
                        quantity: row.querySelector('.item-quantity').value,
                        hours: row.querySelector('.item-hours').value,
                        rate: row.querySelector('.item-rate').value,
                        amount: row.querySelector('.item-amount').value
                    });
                });
            }
        }

        // Restore original form values (for cancel functionality)
        function restoreOriginalFormValues() {
            document.getElementById('documentType').value = originalFormValues.documentType;
            document.getElementById('documentDate').value = originalFormValues.documentDate;
            document.getElementById('clientName').value = originalFormValues.clientName;
            document.getElementById('companyName').value = originalFormValues.companyName;
            document.getElementById('clientEmail').value = originalFormValues.clientEmail;
            document.getElementById('clientMobile').value = originalFormValues.clientMobile;
            document.getElementById('jobAddress').value = originalFormValues.jobAddress;
            document.getElementById('jobNumber').value = originalFormValues.jobNumber;
            document.getElementById('workOrder').value = originalFormValues.workOrder;
            document.getElementById('bankName').value = originalFormValues.bankName;
            document.getElementById('bsb').value = originalFormValues.bsb;
            document.getElementById('account').value = originalFormValues.account;
            document.getElementById('accountName').value = originalFormValues.accountName;
            
            // Clear and restore items
            if (isMobileDevice()) {
                // Mobile version
                const container = document.getElementById('mobileItemsContainer');
                container.innerHTML = '';
                
                originalFormValues.items.forEach(item => {
                    addMobileItemCard(
                        item.description,
                        parseFloat(item.quantity) || 1,
                        parseFloat(item.hours) || 0,
                        parseFloat(item.rate) || 0,
                        parseFloat(item.amount) || 0
                    );
                });
            } else {
                // Desktop version
                const itemsTableBody = document.getElementById('itemsTableBody');
                itemsTableBody.innerHTML = '';
                
                originalFormValues.items.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'item-row';
                    newRow.innerHTML = `
                        <td>
                            <div class="autocomplete-container">
                                <input type="text" class="glass-input large item-description" value="${item.description}" required autocomplete="off">
                                <div class="autocomplete-suggestion"></div>
                                <button class="autocomplete-accept" style="display: none;">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                        <td><input type="number" class="glass-input medium item-quantity" value="${item.quantity}" min="0" step="1"></td>
                        <td><input type="number" class="glass-input medium item-hours" value="${item.hours}" min="0" step="0.5"></td>
                        <td><input type="number" class="glass-input medium-large item-rate" value="${item.rate}" min="0" step="0.01" required></td>
                        <td><input type="text" class="glass-input small item-amount" value="${item.amount}" readonly></td>
                        <td><button type="button" class="glass-button remove-item"><i class="fas fa-trash"></i></button></td>
                        <!-- Hidden input for image data -->
                        <input type="hidden" class="item-image">
                    `;
                    itemsTableBody.appendChild(newRow);
                    enableAutocomplete(newRow.querySelector('.item-description'), newRow.querySelector('.autocomplete-suggestion'), newRow.querySelector('.autocomplete-accept'));
                });
            }
            
            calculateTotals();
            updatePaymentDetailsDisplay();
            updateDocumentNumberDisplay();
            
            // Reinitialize autocomplete for all description fields
            setTimeout(() => {
                initializeAllAutocompletes();
            }, 100);
        }

        // Add this new function to initialize all autocomplete fields
        function initializeAllAutocompletes() {
            // Initialize desktop autocomplete
            document.querySelectorAll('.item-description').forEach(input => {
                const container = input.closest('.autocomplete-container');
                const suggestion = container.querySelector('.autocomplete-suggestion');
                const acceptBtn = container.querySelector('.autocomplete-accept');
                if (input && suggestion && acceptBtn) {
                    enableAutocomplete(input, suggestion, acceptBtn);
                }
            });
            
            // Initialize mobile autocomplete
            document.querySelectorAll('.mobile-item-card').forEach(card => {
                const input = card.querySelector('.item-description');
                const container = input?.closest('.autocomplete-container');
                const suggestion = container?.querySelector('.autocomplete-suggestion');
                const acceptBtn = container?.querySelector('.autocomplete-accept');
                if (input && suggestion && acceptBtn) {
                    enableAutocomplete(input, suggestion, acceptBtn);
                }
            });
        }

        // Initialize mobile items view
        function initializeMobileItems() {
            // Hide desktop table and show mobile container
            document.getElementById('itemsTable').style.display = 'none';
            document.getElementById('mobileItemsContainer').style.display = 'block';
            
            // Create initial mobile item card
            addMobileItemCard();
        }

        // Add a new mobile item card
        function addMobileItemCard(description = '', quantity = 1, hours = 0, rate = 0, amount = 0) {
            const container = document.getElementById('mobileItemsContainer');
            const itemId = 'mobile-item-' + Date.now();
            
            const card = document.createElement('div');
            card.className = 'mobile-item-card';
            card.id = itemId;
            
            card.innerHTML = `
                <div class="mobile-item-header">
                    <div class="mobile-item-title">
                        <i class="fas fa-box"></i>
                        <span>Item ${container.children.length + 1}</span>
                    </div>
                    <i class="fas fa-chevron-down mobile-item-expand"></i>
                </div>
                <div class="mobile-item-content">
                    <div class="mobile-item-row">
                        <div class="mobile-item-label">Description:</div>
                        <div class="mobile-item-value">
                            <div class="autocomplete-container">
                                <input type="text" class="glass-input large item-description" value="${description}" required autocomplete="off">
                                <div class="autocomplete-suggestion"></div>
                                <button class="autocomplete-accept" style="display: none;">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                            <!-- Hidden input for image data -->
                            <input type="hidden" class="item-image" data-image-data="${amount ? '' : ''}">
                        </div>
                    </div>
                    <div class="mobile-item-row">
                        <div class="mobile-item-label">Quantity:</div>
                        <div class="mobile-item-value">
                            <input type="number" class="glass-input medium item-quantity" value="${quantity}" min="0" step="1">
                        </div>
                    </div>
                    <div class="mobile-item-row">
                        <div class="mobile-item-label">Hours:</div>
                        <div class="mobile-item-value">
                            <input type="number" class="glass-input medium item-hours" value="${hours}" min="0" step="0.5">
                        </div>
                    </div>
                    <div class="mobile-item-row">
                        <div class="mobile-item-label">Rate ($):</div>
                        <div class="mobile-item-value">
                            <input type="number" class="glass-input medium-large item-rate" value="${rate}" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="mobile-item-row">
                        <div class="mobile-item-label">Amount ($):</div>
                        <div class="mobile-item-value">
                            <input type="text" class="glass-input small item-amount" value="${amount.toFixed(2)}" readonly>
                        </div>
                    </div>
                    <div class="mobile-item-actions">
                        <button type="button" class="glass-button remove-item">
                            <i class="fas fa-trash"></i> Remove Item
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
            
            // Setup event listeners for this card
            const header = card.querySelector('.mobile-item-header');
            const expandIcon = card.querySelector('.mobile-item-expand');
            const content = card.querySelector('.mobile-item-content');
            const removeBtn = card.querySelector('.remove-item');
            const descriptionInput = card.querySelector('.item-description');
            const quantityInput = card.querySelector('.item-quantity');
            const hoursInput = card.querySelector('.item-hours');
            const rateInput = card.querySelector('.item-rate');
            const amountInput = card.querySelector('.item-amount');
            const suggestion = card.querySelector('.autocomplete-suggestion');
            const acceptBtn = card.querySelector('.autocomplete-accept');
            const imageInput = card.querySelector('.item-image');
            
            // Toggle expand/collapse
            header.addEventListener('click', () => {
                card.classList.toggle('expanded');
            });
            
            // Remove item
            removeBtn.addEventListener('click', () => {
                if (container.children.length > 1) {
                    card.remove();
                    updateMobileItemTitles();
                    calculateTotals();
                } else {
                    showNotification('Cannot remove the last item row.', 'warning');
                }
            });
            
            // Calculate amount when quantity, hours, or rate changes
            const calculateAmount = () => {
                // Use standard accounting calculation: Quantity × Rate
                const qty = parseFloat(quantityInput.value) || 0;
                const rt = parseFloat(rateInput.value) || 0;
                const amt = qty * rt;
                
                amountInput.value = amt.toFixed(2);
                calculateTotals();
            };
            
            quantityInput.addEventListener('input', calculateAmount);
            hoursInput.addEventListener('input', calculateAmount);
            rateInput.addEventListener('input', calculateAmount);
            
            // Setup autocomplete for description
            enableAutocomplete(descriptionInput, suggestion, acceptBtn);
            
            // Expand the first item by default
            if (container.children.length === 1) {
                card.classList.add('expanded');
            }
            
            return card;
        }

        // Update mobile item titles
        function updateMobileItemTitles() {
            const container = document.getElementById('mobileItemsContainer');
            const cards = container.querySelectorAll('.mobile-item-card');
            
            cards.forEach((card, index) => {
                const titleSpan = card.querySelector('.mobile-item-title span');
                titleSpan.textContent = `Item ${index + 1}`;
            });
        }

        // Load user settings
        async function loadUserSettings() {
            if (!currentUser) return;
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get({ source: 'server' });
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Load company info
                    if (userData.companyInfo) {
                        companyInfo = { ...companyInfo, ...userData.companyInfo };
                    }
                    
                    // Load bank info
                    if (userData.bankInfo) {
                        bankInfo = { ...bankInfo, ...userData.bankInfo };
                    }
                    
                    // Load appearance settings
                    if (userData.appearanceSettings) {
                        appearanceSettings = { ...appearanceSettings, ...userData.appearanceSettings };
                        applyAppearanceSettings();
                    }
                    
                    // Load logo
                    if (userData.logoUrl) {
                        logoData = userData.logoUrl;
                    }
                    
                    // Load bank details for form
                    if (userData.bankDetails) {
                        const bankName = userData.bankDetails.bankName || '';
                        const bsb = userData.bankDetails.bsb || '';
                        const account = userData.bankDetails.account || '';
                        const accountName = userData.bankDetails.accountName || 'SMART SQUAD M BUILD PTY LTD';
                        
                        document.getElementById('bankName').value = bankName;
                        document.getElementById('bsb').value = bsb;
                        document.getElementById('account').value = account;
                        document.getElementById('accountName').value = accountName;
                        
                        localStorage.setItem('userBankName', bankName);
                        localStorage.setItem('userBSB', bsb);
                        localStorage.setItem('userAccount', account);
                        localStorage.setItem('userAccountName', accountName);
                    }
                    
                    // Save to IndexedDB for offline use
                    await saveSettingsToIndexedDB({
                        companyInfo,
                        bankInfo,
                        appearanceSettings,
                        logoData
                    });
                    
                    updateCompanyInfoHeader();
                    updateHeaderLogo(logoData);
                    populateSettingsForm();
                    updatePaymentDetailsDisplay();
                } else {
                    console.log("User document does not exist, using default settings.");
                    await ensureAllowedUserExists();
                    updateCompanyInfoHeader();
                    updateHeaderLogo(logoData);
                    populateSettingsForm();
                    updatePaymentDetailsDisplay();
                    
                    // Save default settings to IndexedDB
                    await saveSettingsToIndexedDB({
                        companyInfo,
                        bankInfo,
                        appearanceSettings,
                        logoData
                    });
                }
            } catch (error) {
                // Don't show errors if user is not logged in (permission errors are expected)
                if (!currentUser || error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
                    console.log("Skipping settings load - user not authenticated");
                } else {
                    console.error("Error loading user settings: " + error.message);
                    showNotification("Error loading settings: " + error.message, "error");
                }
                
                // Always update UI with default values
                updateCompanyInfoHeader();
                updateHeaderLogo(logoData);
                populateSettingsForm();
                updatePaymentDetailsDisplay();
            }
        }

        // Save user settings
        async function saveUserSettings() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    companyInfo: companyInfo,
                    bankInfo: bankInfo,
                    appearanceSettings: appearanceSettings,
                    logoUrl: logoData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Also save to IndexedDB for offline use
                await saveSettingsToIndexedDB({
                    companyInfo,
                    bankInfo,
                    appearanceSettings,
                    logoData
                });
                
                showNotification("Settings saved successfully!", "success");
                updateCompanyInfoHeader();
                updateHeaderLogo(logoData);
            } catch (error) {
                console.error("Error saving user settings:", error);
                showNotification("Error saving settings: " + error.message, "error");
            }
        }

        // Apply appearance settings
        function applyAppearanceSettings() {
            document.documentElement.style.setProperty('--primary-color', appearanceSettings.primaryColor);
            document.documentElement.style.setProperty('--secondary-color', appearanceSettings.secondaryColor);
            document.documentElement.style.setProperty('--accent-color', appearanceSettings.accentColor);
        }

        // Populate settings form with current values
        function populateSettingsForm() {
            // Company details
            document.getElementById('settingsCompanyName').value = companyInfo.name;
            document.getElementById('settingsCompanyABN').value = companyInfo.abn;
            document.getElementById('settingsCompanyEmail').value = companyInfo.email;
            document.getElementById('settingsCompanyPhone').value = companyInfo.phone;
            document.getElementById('settingsCompanyAddress').value = companyInfo.address || '';
            document.getElementById('settingsCompanyWebsite').value = companyInfo.website || '';
            
            // Bank details
            document.getElementById('settingsBankName').value = bankInfo.name || '';
            document.getElementById('settingsBankBSB').value = bankInfo.bsb || '';
            document.getElementById('settingsBankAccount').value = bankInfo.account || '';
            document.getElementById('settingsBankAccountName').value = bankInfo.accountName || 'SMART SQUAD M BUILD PTY LTD';
            
            // Appearance settings
            document.getElementById('settingsPrimaryColor').value = appearanceSettings.primaryColor;
            document.getElementById('settingsSecondaryColor').value = appearanceSettings.secondaryColor;
            document.getElementById('settingsAccentColor').value = appearanceSettings.accentColor;
            document.getElementById('settingsPdfFooter').value = appearanceSettings.pdfFooter;
            document.getElementById('settingsPdfTerms').value = appearanceSettings.pdfTerms;
            
            // Logo preview
            document.getElementById('logoPreview').src = logoData;
        }

        // Setup settings modal
        function setupSettingsModal() {
            // Settings button - removed from header
            
            // Close settings modal
            document.getElementById('closeSettingsModal').addEventListener('click', () => {
                document.getElementById('settingsModal').style.display = 'none';
            });
            
            // Settings tabs
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const settingsContents = document.querySelectorAll('.settings-content');
            
            settingsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.id.replace('Tab', 'Content');
                    
                    // Update active tab
                    settingsTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    settingsContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Save settings button
            document.getElementById('saveSettings').addEventListener('click', () => {
                // Update company info from form
                companyInfo.name = document.getElementById('settingsCompanyName').value;
                companyInfo.abn = document.getElementById('settingsCompanyABN').value;
                companyInfo.email = document.getElementById('settingsCompanyEmail').value;
                companyInfo.phone = document.getElementById('settingsCompanyPhone').value;
                companyInfo.address = document.getElementById('settingsCompanyAddress').value;
                companyInfo.website = document.getElementById('settingsCompanyWebsite').value;
                
                // Update bank info from form
                bankInfo.name = document.getElementById('settingsBankName').value;
                bankInfo.bsb = document.getElementById('settingsBankBSB').value;
                bankInfo.account = document.getElementById('settingsBankAccount').value;
                bankInfo.accountName = document.getElementById('settingsBankAccountName').value || 'SMART SQUAD M BUILD PTY LTD';
                
                // Update appearance settings from form
                appearanceSettings.primaryColor = document.getElementById('settingsPrimaryColor').value;
                appearanceSettings.secondaryColor = document.getElementById('settingsSecondaryColor').value;
                appearanceSettings.accentColor = document.getElementById('settingsAccentColor').value;
                appearanceSettings.pdfFooter = document.getElementById('settingsPdfFooter').value;
                appearanceSettings.pdfTerms = document.getElementById('settingsPdfTerms').value;
                
                // Apply appearance settings
                applyAppearanceSettings();
                
                // Save to Firebase and IndexedDB
                saveUserSettings();
                updatePaymentDetailsDisplay();
            });
            
            // Reset settings button
            document.getElementById('resetSettings').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all settings to default values?')) {
                    // Reset to default values
                    companyInfo = {
                        name: "SMART SQUAD M BUILD PTY LTD",
                        abn: "14 670 018 069",
                        email: "smartsquad.m23@gmail.com",
                        phone: "0470 136 187",
                        address: "",
                        website: ""
                    };
                    
                    bankInfo = {
                        name: "",
                        bsb: "",
                        account: "",
                        accountName: "SMART SQUAD M BUILD PTY LTD"
                    };
                    
                    appearanceSettings = {
                        primaryColor: "#1a3a5f",
                        secondaryColor: "#2c5282",
                        accentColor: "#f97316",
                        pdfFooter: "Thank you for your business!",
                        pdfTerms: "Payment due within 14 days. Late payments may incur interest at 5% per month."
                    };
                    
                    logoData = "logo.png";
                    
                    // Apply appearance settings
                    applyAppearanceSettings();
                    
                    // Update form
                    populateSettingsForm();
                    
                    // Save to Firebase and IndexedDB
                    saveUserSettings();
                    updatePaymentDetailsDisplay();
                }
            });
            
            // Logo upload
            document.getElementById('logoUpload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Check file type
                    if (!file.type.match('image.*')) {
                        showNotification('Please select an image file.', 'error');
                        return;
                    }
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Image size should be less than 5MB.', 'error');
                        return;
                    }
                    
                    // Read file and update preview
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        document.getElementById('logoPreview').src = imageUrl;
                        logoData = imageUrl;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Setup Simple Search Functionality
        function setupSimpleSearch() {
            // Invoice search
            const invoiceSearchInput = document.getElementById('searchInvoices');
            const invoiceSearchBtn = document.getElementById('searchInvoicesBtn');
            const clearInvoicesSearch = document.getElementById('clearInvoicesSearch');
            const invoiceSearchResults = document.getElementById('invoiceSearchResults');
            
            // Quotation search
            const quotationSearchInput = document.getElementById('searchQuotations');
            const quotationSearchBtn = document.getElementById('searchQuotationsBtn');
            const clearQuotationsSearch = document.getElementById('clearQuotationsSearch');
            const quotationSearchResults = document.getElementById('quotationSearchResults');
            
            // Setup search functionality for both tabs
            setupSimpleSearchFunctionality('Invoice', invoiceSearchInput, invoiceSearchBtn, clearInvoicesSearch, invoiceSearchResults);
            setupSimpleSearchFunctionality('Quote', quotationSearchInput, quotationSearchBtn, clearQuotationsSearch, quotationSearchResults);
        }

        function setupSimpleSearchFunctionality(docType, searchInput, searchBtn, clearBtn, resultsInfo) {
            let searchTimeout;
            let currentSearchTerm = '';
            
            // Simple search function
            const performSearch = (searchTerm) => {
                if (!searchTerm || searchTerm.trim() === '') {
                    renderDocuments(allDocuments.filter(doc => doc.data.type === docType));
                    resultsInfo.style.display = 'none';
                    clearBtn.style.display = 'none';
                    return;
                }
                
                const lowerQuery = searchTerm.toLowerCase();
                const results = [];
                
                // Simple search algorithm
                allDocuments.forEach(doc => {
                    if (doc.data.type !== docType) return;
                    
                    const data = doc.data;
                    
                    // Search in document number
                    if (data.number.toLowerCase().includes(lowerQuery)) {
                        results.push(doc);
                        return;
                    }
                    
                    // Search in client name
                    if (data.billTo.name.toLowerCase().includes(lowerQuery)) {
                        results.push(doc);
                        return;
                    }
                    
                    // Search in company name
                    if (data.billTo.company && data.billTo.company.toLowerCase().includes(lowerQuery)) {
                        results.push(doc);
                        return;
                    }
                    
                    // Search in date
                    if (data.date.toLowerCase().includes(lowerQuery)) {
                        results.push(doc);
                        return;
                    }
                    
                    // Search in total amount
                    if (data.total.toString().includes(lowerQuery)) {
                        results.push(doc);
                        return;
                    }
                });
                
                // Render results
                renderDocuments(results);
                
                // Show results info
                resultsInfo.textContent = `Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${searchTerm}"`;
                resultsInfo.style.display = 'block';
                clearBtn.style.display = 'flex';
            };
            
            // Input event listener with debouncing
            searchInput.addEventListener('input', (e) => {
                currentSearchTerm = e.target.value;
                
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(currentSearchTerm);
                }, 300);
            });
            
            // Search button click
            searchBtn.addEventListener('click', () => {
                performSearch(currentSearchTerm);
            });
            
            // Clear button click
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                currentSearchTerm = '';
                performSearch('');
            });
            
            // Enter key press
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch(currentSearchTerm);
                }
            });
        }

        // Setup tabs functionality
        function setupTabs() {
            const invoicesTab = document.getElementById('invoicesTab');
            const quotationsTab = document.getElementById('quotationsTab');
            const invoicesContent = document.getElementById('invoicesContent');
            const quotationsContent = document.getElementById('quotationsContent');
            
            invoicesTab.addEventListener('click', () => {
                invoicesTab.classList.add('active');
                quotationsTab.classList.remove('active');
                invoicesContent.classList.add('active');
                quotationsContent.classList.remove('active');
            });
            
            quotationsTab.addEventListener('click', () => {
                quotationsTab.classList.add('active');
                invoicesTab.classList.remove('active');
                quotationsContent.classList.add('active');
                invoicesContent.classList.remove('active');
            });
        }

        // Setup dropdown menu functionality
        function setupDropdownMenu() {
            const userEmail = document.getElementById('userEmail');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            
            if (userEmail && dropdownMenu) {
                userEmail.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('show');
                });
                
                document.addEventListener('click', () => {
                    dropdownMenu.classList.remove('show');
                });
                
                dropdownMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        // Setup logout functionality
        function setupLogoutButton() {
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await performLogout();
                });
            }
        }

        // Perform logout
        async function performLogout() {
            const confirmLogout = confirm('Are you sure you want to logout?\n\nAny unsaved changes will be lost.');
            
            if (!confirmLogout) {
                return;
            }

            try {
                const logoutBtn = document.getElementById('logoutBtn');
                const originalContent = logoutBtn ? logoutBtn.innerHTML : '';
                
                if (logoutBtn) {
                    logoutBtn.disabled = true;
                    logoutBtn.innerHTML = '<div class="loading-spinner"></div> Logging out...';
                }
                
                await auth.signOut();
                
                console.log("User logged out successfully");
                showNotification("Logged out successfully!", "success");
                
            } catch (error) {
                console.error("Logout error:", error);
                showNotification("Error logging out. Please try again.", "error");
                
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.disabled = false;
                    logoutBtn.innerHTML = originalContent;
                }
            }
        }

        // Show authentication modal
        function showAuthModal() {
            document.getElementById('appContainer').style.display = 'none';
            const authModal = document.getElementById('authModal');
            authModal.style.display = 'flex';
            authModal.classList.add('active');
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('authForm').reset();
            document.getElementById('authEmailError').style.display = 'none';
            document.getElementById('authButtonText').textContent = 'Login';
        }

        // Show forgot password modal
        function showForgotPasswordModal() {
            const authModal = document.getElementById('authModal');
            authModal.style.display = 'none';
            authModal.classList.remove('active');
            document.getElementById('forgotPasswordModal').style.display = 'flex';
            document.getElementById('forgotPasswordForm').reset();
            document.getElementById('resetEmailError').style.display = 'none';
            document.getElementById('resetEmailSuccess').style.display = 'none';
        }

        // Hide forgot password modal and show auth modal
        function hideForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            const authModal = document.getElementById('authModal');
            authModal.style.display = 'flex';
            authModal.classList.add('active');
        }

        // Send password reset email
        async function sendPasswordReset(email) {
            try {
                await auth.sendPasswordResetEmail(email);
                return { success: true };
            } catch (error) {
                console.error('Password reset error:', error);
                return { success: false, error: error.message };
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            setupLogoutButton();

            const saveButtonElement = document.getElementById('saveButton');
            if (saveButtonElement) {
                saveButtonElement.addEventListener('click', saveDocument);
            }
            
            // Update the clear form button to cancel form
            const cancelFormElement = document.getElementById('cancelForm');
            if (cancelFormElement) {
                cancelFormElement.addEventListener('click', cancelForm);
            }
            
            // Add print PDF button event listener
            const printPdfButtonElement = document.getElementById('printPdfButton');
            if (printPdfButtonElement) {
                printPdfButtonElement.addEventListener('click', () => {
                    const documentData = getDocumentDataFromForm();
                    if (documentData) {
                        printDocument(documentData);
                    }
                });
            }
            
            // Add email button event listener
            const emailButtonElement = document.getElementById('emailButton');
            if (emailButtonElement) {
                emailButtonElement.addEventListener('click', () => {
                    const documentData = getDocumentDataFromForm();
                    if (documentData) {
                        emailDocument(documentData);
                    }
                });
            }
            
            // Update the add item button event listener
            const addItemElement = document.getElementById('addItem');
            if (addItemElement) {
                addItemElement.addEventListener('click', () => {
                if (isMobileDevice()) {
                    // Mobile version
                    const card = addMobileItemCard();
                    // Initialize autocomplete for the new card
                    setTimeout(() => {
                        const input = card.querySelector('.item-description');
                        const suggestion = card.querySelector('.autocomplete-suggestion');
                        const acceptBtn = card.querySelector('.autocomplete-accept');
                        if (input && suggestion && acceptBtn) {
                            enableAutocomplete(input, suggestion, acceptBtn);
                        }
                    }, 100);
                } else {
                    // Desktop version with updated size classes
                    const newRow = document.createElement('tr');
                    newRow.className = 'item-row';
                    newRow.innerHTML = `
                        <td>
                            <div class="autocomplete-container">
                                <input type="text" class="glass-input large item-description" required autocomplete="off">
                                <div class="autocomplete-suggestion"></div>
                                <button class="autocomplete-accept" style="display: none;">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                        <td><input type="number" class="glass-input medium item-quantity" value="1" min="0" step="1"></td>
                        <td><input type="number" class="glass-input medium item-hours" value="0" min="0" step="0.5"></td>
                        <td><input type="number" class="glass-input medium-large item-rate" value="0.00" min="0" step="0.01" required></td>
                        <td><input type="text" class="glass-input small item-amount" value="0.00" readonly></td>
                        <td><button type="button" class="glass-button remove-item"><i class="fas fa-trash"></i></button></td>
                        <!-- Hidden input for image data -->
                        <input type="hidden" class="item-image">
                    `;
                    document.getElementById('itemsTableBody').appendChild(newRow);
                    
                    // Initialize autocomplete for the new row
                    setTimeout(() => {
                        const input = newRow.querySelector('.item-description');
                        const suggestion = newRow.querySelector('.autocomplete-suggestion');
                        const acceptBtn = newRow.querySelector('.autocomplete-accept');
                        if (input && suggestion && acceptBtn) {
                            enableAutocomplete(input, suggestion, acceptBtn);
                        }
                        newRow.querySelector('.item-description').focus();
                    }, 100);
                }
                
                // Update original form values after adding a new item
                storeOriginalFormValues();
                });
            }

            // Desktop items table event listeners
            const itemsTableBodyElement = document.getElementById('itemsTableBody');
            if (itemsTableBodyElement) {
                itemsTableBodyElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
                    const row = e.target.closest('.item-row');
                    if (document.querySelectorAll('.item-row').length > 1) {
                        row.remove();
                        calculateTotals();
                        // Update original form values after removing an item
                        storeOriginalFormValues();
                    } else {
                        showNotification('Cannot remove the last item row.', 'warning');
                    }
                }
                });

                // Fixed calculation for desktop items
                itemsTableBodyElement.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-quantity') || 
                    e.target.classList.contains('item-hours') || 
                    e.target.classList.contains('item-rate')) {
                    const row = e.target.closest('.item-row');
                    const quantityInput = row.querySelector('.item-quantity');
                    const hoursInput = row.querySelector('.item-hours');
                    const rateInput = row.querySelector('.item-rate');
                    const amountInput = row.querySelector('.item-amount');
                    
                    // Use standard accounting calculation: Quantity × Rate
                    const qty = parseFloat(quantityInput.value) || 0;
                    const rt = parseFloat(rateInput.value) || 0;
                    const amt = qty * rt;
                    
                    amountInput.value = amt.toFixed(2);
                    calculateTotals();
                }
                });
            }

            const documentTypeElement = document.getElementById('documentType');
            if (documentTypeElement) {
                documentTypeElement.addEventListener('change', function() {
                    updateSequenceDisplay();
                    if (!editingDocId) {
                        updateDocumentNumberDisplay();
                    }
                    // Update original form values when document type changes
                    storeOriginalFormValues();
                });
            }

            const closeDetailModalElement = document.getElementById('closeDetailModal');
            if (closeDetailModalElement) {
                closeDetailModalElement.addEventListener('click', function() {
                    document.getElementById('documentDetailModal').style.display = 'none';
                });
            }
            
            const closeDetailModalFooterElement = document.getElementById('closeDetailModalFooter');
            if (closeDetailModalFooterElement) {
                closeDetailModalFooterElement.addEventListener('click', function() {
                    document.getElementById('documentDetailModal').style.display = 'none';
                });
            }

            const printDetailBtnElement = document.getElementById('printDetailBtn');
            if (printDetailBtnElement) {
                printDetailBtnElement.addEventListener('click', function() {
                    if (currentDocumentForShare) {
                        printDocument(currentDocumentForShare.data);
                    }
                });
            }

            const closeShareModalElement = document.getElementById('closeShareModal');
            if (closeShareModalElement) {
                closeShareModalElement.addEventListener('click', function() {
                    document.getElementById('shareModal').style.display = 'none';
                });
            }
            
            const closeShareModalFooterElement = document.getElementById('closeShareModalFooter');
            if (closeShareModalFooterElement) {
                closeShareModalFooterElement.addEventListener('click', function() {
                    document.getElementById('shareModal').style.display = 'none';
                });
            }

            const shareDownloadElement = document.getElementById('shareDownload');
            if (shareDownloadElement) {
                shareDownloadElement.addEventListener('click', () => downloadPDF());
            }

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    loadDocuments();
                    loadUserSettings();
                    loadUserSequences();
                }
            });

            window.addEventListener('focus', () => {
                if (currentUser) {
                    loadDocuments();
                    loadUserSettings();
                    loadUserSequences();
                }
            });
            
            // Clear payment details button
            const clearPaymentDetailsElement = document.getElementById('clearPaymentDetails');
            if (clearPaymentDetailsElement) {
                clearPaymentDetailsElement.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear the payment details?')) {
                        document.getElementById('bankName').value = '';
                        document.getElementById('bsb').value = '';
                        document.getElementById('account').value = '';
                        // Don't clear account name as it's a static field
                        updatePaymentDetailsDisplay();
                        
                        // Also clear from storage
                        localStorage.removeItem('lastPaymentDetails');
                        
                        if (currentUser) {
                            db.collection('users').doc(currentUser.uid).update({
                                lastPaymentDetails: firebase.firestore.FieldValue.delete()
                            }).catch(error => {
                                console.error("Error clearing payment details from Firestore:", error);
                            });
                        }
                    }
                });
            }
        }

        // Share via SMS Function
        function shareViaSMS(data) {
            const message = `Hi ${data.billTo.name || ''}, here is your ${data.type.toLowerCase()} ${data.number} from ${companyInfo.name}. Total: $${data.total.toFixed(2)}. Contact ${companyInfo.phone} for details.`;
            
            // This works on mobile devices with SMS capability
            const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
            window.open(smsUrl, '_blank');
        }

        // Load bank details
        async function loadBankDetails() {
            if (!currentUser) return;
            
            const savedBankName = localStorage.getItem('userBankName');
            const savedBSB = localStorage.getItem('userBSB');
            const savedAccount = localStorage.getItem('userAccount');
            const savedAccountName = localStorage.getItem('userAccountName');
            
            if (savedBankName) {
                document.getElementById('bankName').value = savedBankName;
            }
            if (savedBSB) {
                document.getElementById('bsb').value = savedBSB;
            }
            if (savedAccount) {
                document.getElementById('account').value = savedAccount;
            }
            // Account name is static, so we don't load it from storage
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get({ source: 'server' });
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.bankDetails) {
                        const bankName = userData.bankDetails.bankName || '';
                        const bsb = userData.bankDetails.bsb || '';
                        const account = userData.bankDetails.account || '';
                        const accountName = userData.bankDetails.accountName || 'SMART SQUAD M BUILD PTY LTD';
                        
                        document.getElementById('bankName').value = bankName;
                        document.getElementById('bsb').value = bsb;
                        document.getElementById('account').value = account;
                        document.getElementById('accountName').value = accountName;
                        
                        localStorage.setItem('userBankName', bankName);
                        localStorage.setItem('userBSB', bsb);
                        localStorage.setItem('userAccount', account);
                        localStorage.setItem('userAccountName', accountName);
                    }
                }
            } catch (error) {
                console.error("Error loading bank details: ", error);
            }
        }

        // Save bank details
        async function saveBankDetails() {
            if (!currentUser) return;
            
            const bankName = document.getElementById('bankName').value.trim();
            const bsb = document.getElementById('bsb').value.trim();
            const account = document.getElementById('account').value.trim();
            const accountName = document.getElementById('accountName').value.trim();
            
            localStorage.setItem('userBankName', bankName);
            localStorage.setItem('userBSB', bsb);
            localStorage.setItem('userAccount', account);
            localStorage.setItem('userAccountName', accountName);
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    bankDetails: { bankName, bsb, account, accountName },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Bank details saved to Firestore");
            } catch (error) {
                console.error("Error saving bank details to Firestore: ", error);
            }
        }

        // Load user sequences
        async function loadUserSequences() {
            if (!currentUser) return;
            try {
                console.log("Loading user sequences...");
                const userDoc = await db.collection('users').doc(currentUser.uid).get({ source: 'server' });

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userSequences.nextInvNumber = userData.nextInvNumber || 255; // Default to 255
                    userSequences.nextQotNumber = userData.nextQotNumber || 288; // Default to 288
                    console.log("Loaded sequences:", userSequences);
                    
                    // Save to IndexedDB for offline use
                    await saveSequencesToIndexedDB(userSequences);
                } else {
                    console.log("User document not found, initializing sequences.");
                    userSequences.nextInvNumber = 255;
                    userSequences.nextQotNumber = 288;
                    
                    // Save to IndexedDB for offline use
                    await saveSequencesToIndexedDB(userSequences);
                }

                updateSequenceDisplay();
                console.log("UI updated with sequences.");
            } catch (error) {
                // Don't show errors if user is not logged in (permission errors are expected)
                if (!currentUser || error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
                    console.log("Skipping sequences load - user not authenticated");
                } else {
                    console.error("Error loading user sequences:", error);
                    showNotification("Error loading document sequences. Please try again.", "error");
                }
                
                // Always update UI with default sequences
                userSequences = { nextInvNumber: 1, nextQotNumber: 1 };
                updateSequenceDisplay();
            }
        }

        // Update Sequence Display UI
        function updateSequenceDisplay() {
            document.getElementById('nextInvNumber').textContent = `INV-${userSequences.nextInvNumber.toString().padStart(5, '0')}`;
            document.getElementById('nextQotNumber').textContent = `QOT-${userSequences.nextQotNumber.toString().padStart(5, '0')}`;
        }

        // Update document number display
        function updateDocumentNumberDisplay() {
            const type = document.getElementById('documentType').value;
            let prefix = type === 'Invoice' ? 'INV' : 'QOT';
            let sequenceNumber = type === 'Invoice' ? userSequences.nextInvNumber : userSequences.nextQotNumber;
            
            const documentNumber = `${prefix}-${sequenceNumber.toString().padStart(5, '0')}`;
            document.getElementById('documentNumber').textContent = documentNumber;
        }

        // Generate document number
        function generateSimpleDocumentNumber(type) {
            let prefix = type === 'Invoice' ? 'INV' : 'QOT';
            const sequenceKey = type === 'Invoice' ? 'nextInvNumber' : 'nextQotNumber';
            const sequenceNumber = userSequences[sequenceKey];
            
            return `${prefix}-${sequenceNumber.toString().padStart(5, '0')}`;
        }

        // Validate document
        async function validateDocument() {
            const documentType = document.getElementById('documentType');
            const documentDate = document.getElementById('documentDate');
            const clientName = document.getElementById('clientName');
            
            // Get items based on device type
            let items;
            if (isMobileDevice()) {
                items = document.querySelectorAll('.mobile-item-card');
            } else {
                items = document.querySelectorAll('.item-row');
            }

            if (!documentType.value) {
                showNotification('Document type is required', 'error');
                return false;
            }
            if (!documentDate.value) {
                showNotification('Document date is required', 'error');
                return false;
            }
            if (!clientName.value.trim()) {
                showNotification('Client name is required', 'error');
                return false;
            }

            let hasValidItem = false;
            items.forEach(item => {
                let description, quantity, hours, rate;
                
                if (isMobileDevice()) {
                    description = item.querySelector('.item-description').value.trim();
                    quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                    hours = parseFloat(item.querySelector('.item-hours').value) || 0;
                    rate = parseFloat(item.querySelector('.item-rate').value) || 0;
                } else {
                    description = item.querySelector('.item-description').value.trim();
                    quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                    hours = parseFloat(item.querySelector('.item-hours').value) || 0;
                    rate = parseFloat(item.querySelector('.item-rate').value) || 0;
                }
                
                if (description && rate > 0 && quantity > 0) {
                    hasValidItem = true;
                }
            });
            
            if (!hasValidItem) {
                showNotification('At least one valid item is required (with description, rate, and quantity)', 'error');
                return false;
            }

            return true;
        }

        // Save the last used payment details
        async function saveLastPaymentDetails() {
            if (!currentUser) return;
            
            const bankName = document.getElementById('bankName').value.trim();
            const bsb = document.getElementById('bsb').value.trim();
            const account = document.getElementById('account').value.trim();
            const accountName = document.getElementById('accountName').value.trim();
            
            // Save to localStorage for immediate access
            localStorage.setItem('lastPaymentDetails', JSON.stringify({
                bankName, bsb, account, accountName
            }));
            
            // Save to Firebase for persistence across devices
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    lastPaymentDetails: { bankName, bsb, account, accountName },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log("Last payment details saved to Firestore");
            } catch (error) {
                console.error("Error saving last payment details to Firestore: ", error);
            }
        }

        // Load the last used payment details
        async function loadLastPaymentDetails() {
            // First try to load from localStorage for immediate access
            const localDetails = localStorage.getItem('lastPaymentDetails');
            if (localDetails) {
                try {
                    const details = JSON.parse(localDetails);
                    populatePaymentDetails(details);
                } catch (e) {
                    console.error("Error parsing local payment details:", e);
                }
            }
            
            // Then try to load from Firebase for the most up-to-date details
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get({ source: 'server' });
                if (userDoc.exists && userDoc.data().lastPaymentDetails) {
                    const details = userDoc.data().lastPaymentDetails;
                    populatePaymentDetails(details);
                    
                    // Update localStorage with the latest from Firebase
                    localStorage.setItem('lastPaymentDetails', JSON.stringify(details));
                }
            } catch (error) {
                console.error("Error loading last payment details from Firestore: ", error);
            }
        }

        // Helper function to populate payment details in the form
        function populatePaymentDetails(details) {
            if (details.bankName) document.getElementById('bankName').value = details.bankName;
            if (details.bsb) document.getElementById('bsb').value = details.bsb;
            if (details.account) document.getElementById('account').value = details.account;
            if (details.accountName) document.getElementById('accountName').value = details.accountName;
            
            // Update the display
            updatePaymentDetailsDisplay();
        }

        // Save document
        async function saveDocument() {
            if (!currentUser || currentUser.uid !== ALLOWED_UID) {
                showNotification('You are not authorized to save documents.', 'error');
                return;
            }

            if (!await validateDocument()) {
                console.log("Document validation failed.");
                return;
            }

            const saveButton = document.getElementById('saveButton');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<div class="loading-spinner"></div> Saving...';

            try {
                const type = document.getElementById('documentType').value;
                const date = document.getElementById('documentDate').value;
                const clientName = document.getElementById('clientName').value.trim();
                const clientCompany = document.getElementById('companyName').value.trim();
                const clientEmail = document.getElementById('clientEmail').value.trim();
                const clientMobile = document.getElementById('clientMobile').value.trim();
                const jobAddress = document.getElementById('jobAddress').value.trim();
                const jobNumber = document.getElementById('jobNumber').value.trim();
                const workOrder = document.getElementById('workOrder').value.trim();
                const bankName = document.getElementById('bankName').value.trim();
                const bsb = document.getElementById('bsb').value.trim();
                const account = document.getElementById('account').value.trim();
                const accountName = document.getElementById('accountName').value.trim();

                await saveBankDetails();

                // Get items based on device type
                let itemsArray = [];
                let imagesArray = [];
                
                if (isMobileDevice()) {
                    const itemCards = document.querySelectorAll('.mobile-item-card');
                    itemCards.forEach((card, index) => {
                        const description = card.querySelector('.item-description').value.trim();
                        const quantity = parseFloat(card.querySelector('.item-quantity').value) || 0;
                        const hours = parseFloat(card.querySelector('.item-hours').value) || 0;
                        const rate = parseFloat(card.querySelector('.item-rate').value) || 0;
                        const amount = parseFloat(card.querySelector('.item-amount').value) || 0;
                        
                        // Safely get image data
                        const imageInput = card.querySelector('.item-image');
                        let imageData = null;
                        if (imageInput && imageInput.dataset) {
                            imageData = imageInput.dataset.imageData || null;
                        }
                        
                        if (description && rate > 0 && quantity > 0) {
                            itemsArray.push({
                                description: description,
                                quantity: quantity,
                                hours: hours,
                                rate: rate,
                                amount: amount,
                                image: imageData
                            });
                        }
                    });
                } else {
                    const itemRows = document.querySelectorAll('.item-row');
                    itemRows.forEach((row, index) => {
                        const description = row.querySelector('.item-description').value.trim();
                        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                        const hours = parseFloat(row.querySelector('.item-hours').value) || 0;
                        const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                        const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
                        
                        // Safely get image data
                        const imageInput = row.querySelector('.item-image');
                        let imageData = null;
                        if (imageInput && imageInput.dataset) {
                            imageData = imageInput.dataset.imageData || null;
                        }
                        
                        if (description && rate > 0 && quantity > 0) {
                            itemsArray.push({
                                description: description,
                                quantity: quantity,
                                hours: hours,
                                rate: rate,
                                amount: amount,
                                image: imageData
                            });
                        }
                    });
                }

                const subtotalElement = document.getElementById('subtotal');
                const gstElement = document.getElementById('gst');
                const totalElement = document.getElementById('total');

                let docNumber;
                if (editingDocId) {
                    const docSnapshot = await db.collection('quotes').doc(editingDocId).get({ source: 'server' });
                    if (docSnapshot.exists) {
                        docNumber = docSnapshot.data().number;
                    } else {
                        docNumber = generateSimpleDocumentNumber(type);
                    }
                } else {
                    docNumber = generateSimpleDocumentNumber(type);
                }

                const documentData = {
                    type: type,
                    number: docNumber,
                    date: date,
                    year: new Date(date).getFullYear(),
                    billTo: {
                        name: clientName,
                        company: clientCompany,
                        email: clientEmail,
                        mobile: clientMobile
                    },
                    jobDetails: {
                        address: jobAddress,
                        number: jobNumber,
                        workOrder: workOrder
                    },
                    items: itemsArray,
                    subtotal: parseFloat(subtotalElement.textContent.replace('$', '')),
                    gst: parseFloat(gstElement.textContent.replace('$', '')),
                    total: parseFloat(totalElement.textContent.replace('$', '')),
                    bankDetails: {
                        bankName: bankName,
                        bsb: bsb,
                        account: account,
                        accountName: accountName,
                        name: bankInfo.name,
                        accountName: bankInfo.accountName
                    },
                    companyInfo: companyInfo,
                    userId: ALLOWED_UID,
                    userEmail: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Save to IndexedDB first (for immediate feedback)
                const savedDoc = await saveDocumentToIndexedDB(documentData, !!editingDocId);
                
                // If online, also save to Firebase
                if (isOnline) {
                    let result;
                    if (editingDocId) {
                        await db.collection('quotes').doc(editingDocId).update(documentData);
                        result = { action: 'updated', docId: editingDocId };
                        
                        editingDocId = null;
                        clearForm();
                    } else {
                        documentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        const docRef = await db.collection('quotes').add(documentData);
                        result = { action: 'created', docId: docRef.id };
                        
                        // Update the document in IndexedDB with the Firebase ID
                        if (savedDoc.id.startsWith('temp_')) {
                            const transaction = dbInstance.transaction(['documents'], 'readwrite');
                            const store = transaction.objectStore('documents');
                            
                            // Delete the temp document
                            store.delete(savedDoc.id);
                            
                            // Add the new document with the Firebase ID
                            const syncedDoc = {
                                ...documentData,
                                id: docRef.id,
                                syncStatus: 'synced',
                                lastModified: new Date().toISOString()
                            };
                            
                            store.put(syncedDoc);
                        }

                        const sequenceKey = type === 'Invoice' ? 'nextInvNumber' : 'nextQotNumber';
                        try {
                            await db.collection('users').doc(ALLOWED_UID).update({
                                [sequenceKey]: firebase.firestore.FieldValue.increment(1),
                                lastSequenceUpdate: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (seqErr) {
                            console.warn('Sequence update failed via update():', seqErr && seqErr.message ? seqErr.message : seqErr);
                            // Try to create/merge the field using set with merge:true
                            try {
                                const mergeObj = {
                                    [sequenceKey]: (userSequences[sequenceKey] || 1) + 1,
                                    lastSequenceUpdate: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                await db.collection('users').doc(ALLOWED_UID).set(mergeObj, { merge: true });
                                console.log('Sequence incremented via set(..., {merge:true})');
                            } catch (mergeErr) {
                                console.error('Failed to set sequence on user doc:', mergeErr && mergeErr.message ? mergeErr.message : mergeErr);
                                // Notify user but continue local flow
                                showNotification('Warning: Could not update sequence number on server. It will be retried when possible.', 'warning');
                            }
                        }

                        // Update local sequences and UI regardless of server outcome
                        userSequences[sequenceKey] = (userSequences[sequenceKey] || 1) + 1;
                        updateSequenceDisplay();
                        
                        // Save updated sequences to IndexedDB
                        await saveSequencesToIndexedDB(userSequences);
                        
                        clearForm();
                    }

                    console.log(`Document ${result.action} with ID: `, result.docId);
                    showNotification(`Document ${result.action === 'created' ? 'saved' : 'updated'} successfully!`, "success");
                } else {
                    // If offline, just show a success message for local save
                    showNotification("Document saved locally. It will sync when you're back online.", "info");
                    editingDocId = null;
                    clearForm();
                }

                // After successfully saving the document, save the payment details
                try {
                    await saveLastPaymentDetails();
                    console.log("Payment details saved for future use");
                } catch (error) {
                    console.error("Error saving payment details:", error);
                }

                loadDocuments();

           } catch (error) {
    // This logs the full technical error to the browser's developer console (press F12 to see it)
    console.error('Detailed error during save:', error);

    // This is the FIX: It correctly displays the specific error message in the popup notification
    showNotification(`Error saving document: ${error.message}`, 'error');


    // ... rest of your finally block

            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }

        // Cancel form changes
        function cancelForm() {
            // Restore original form values
            restoreOriginalFormValues();
            
            // Show notification
            showNotification("Changes cancelled. No data was saved.", "warning");
        }

        // Clear the form
        function clearForm() {
            document.getElementById('documentType').value = 'Invoice';
            document.getElementById('documentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('clientName').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientMobile').value = '';
            document.getElementById('jobAddress').value = '';
            document.getElementById('jobNumber').value = '';
            document.getElementById('workOrder').value = '';
            
            // Don't clear payment details - they should persist
            // document.getElementById('bankName').value = '';
            // document.getElementById('bsb').value = '';
            // document.getElementById('account').value = '';
            // document.getElementById('accountName').value = '';

            if (isMobileDevice()) {
                // Mobile version - reset to one empty item
                const container = document.getElementById('mobileItemsContainer');
                container.innerHTML = '';
                addMobileItemCard();
            } else {
                // Desktop version
                const itemsTableBody = document.getElementById('itemsTableBody');
                while (itemsTableBody.children.length > 1) {
                    itemsTableBody.removeChild(itemsTableBody.lastChild);
                }
                const firstRow = itemsTableBody.firstElementChild;
                firstRow.querySelector('.item-description').value = '';
                firstRow.querySelector('.item-quantity').value = '1';
                firstRow.querySelector('.item-hours').value = '0';
                firstRow.querySelector('.item-rate').value = '0.00';
                firstRow.querySelector('.item-amount').value = '0.00';
            }

            document.getElementById('subtotal').textContent = '$0.00';
            document.getElementById('gst').textContent = '$0.00';
            document.getElementById('total').textContent = '$0.00';

            updateDocumentNumberDisplay();
            updatePaymentDetailsDisplay();
            
            // Store the cleared form as the new original
            storeOriginalFormValues();
        }

        // Standard accounting calculation function for item amounts
        function calculateItemAmount(quantityInput, hoursInput, rateInput) {
            // Standard accounting calculation: Amount = Quantity × Rate
            // Hours is just for reference/display and doesn't affect the calculation
            const qty = parseFloat(quantityInput.value) || 0;
            const rt = parseFloat(rateInput.value) || 0;
            
            // If Quantity is 0, the amount should be 0 regardless of hours
            if (qty === 0) {
                return 0;
            }
            
            // Standard calculation: Quantity × Rate
            return qty * rt;
        }

        // Calculate totals
        function calculateTotals() {
            let subtotal = 0;
            
            if (isMobileDevice()) {
                // Mobile version
                const itemCards = document.querySelectorAll('.mobile-item-card');
                itemCards.forEach(card => {
                    const amountStr = card.querySelector('.item-amount').value;
                    const amount = parseFloat(amountStr) || 0;
                    subtotal += amount;
                });
            } else {
                // Desktop version
                document.querySelectorAll('.item-row').forEach(row => {
                    const amountStr = row.querySelector('.item-amount').value;
                    const amount = parseFloat(amountStr) || 0;
                    subtotal += amount;
                });
            }
            
            const gst = subtotal * 0.1;
            const total = subtotal + gst;

            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('gst').textContent = '$' + gst.toFixed(2);
            document.getElementById('total').textContent = '$' + total.toFixed(2);
        }

        // Update payment details display
        function updatePaymentDetailsDisplay() {
            const bankName = document.getElementById('bankName').value.trim();
            const bsb = document.getElementById('bsb').value.trim();
            const account = document.getElementById('account').value.trim();
            const accountName = document.getElementById('accountName').value.trim();
            
            document.getElementById('bankNameDisplay').textContent = bankName || '-';
            document.getElementById('bsbDisplay').textContent = bsb || '-';
            document.getElementById('accountDisplay').textContent = account || '-';
            document.getElementById('accountNameDisplay').textContent = accountName || 'SMART SQUAD M BUILD PTY LTD';
        }

        // Print Document Function
        function printDocument(data) {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            const printHTML = generatePrintHTML(data);
            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
            };
        }

// Share via SMS Function
function shareViaSMS(data) {
    const message = `Hi ${data.billTo.name || ''}, here is your ${data.type.toLowerCase()} ${data.number} from ${companyInfo.name}. Total: $${data.total.toFixed(2)}. Contact ${companyInfo.phone} for details.`;
    
    // This works on mobile devices with SMS capability
    const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
    window.open(smsUrl, '_blank');
}
   // Email Document Function - Modified to include client name
function emailDocument(data) {
    // Generate PDF first (for user to manually attach)
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    const printHTML = generatePrintHTML(data);
    printWindow.document.write(printHTML);
    printWindow.document.close();
    printWindow.onload = () => {
        printWindow.print(); // This prompts the user to print/save as PDF
        // Note: Cannot auto-attach the PDF. User must save it and attach manually.
    };

    // Create a mailto link with the document details, including client name
    const subject = `${data.type} ${data.number} from ${companyInfo.name}`;
    const clientName = data.billTo.name || 'Valued Client'; // Use name or fallback
    const body = `Dear ${clientName},

Please find attached your ${data.type.toLowerCase()} ${data.number} for $${data.total.toFixed(2)}.
If you have any questions, please don't hesitate to contact us.

Best regards,
${companyInfo.name}
${companyInfo.phone}
${companyInfo.email}`;

    const mailtoLink = `mailto:${data.billTo.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
    // User will be prompted to send the email and must manually attach the saved PDF.
}

        // Generate Print HTML
        function generatePrintHTML(data) {
            let itemsHTML = '';
            data.items.forEach(item => {
                itemsHTML += `
                    <tr>
                        <td class="description">${item.description}</td>
                        <td class="quantity">${item.quantity}</td>
                        <td class="hours">${item.hours}</td>
                        <td class="rate">$${item.rate.toFixed(2)}</td>
                        <td class="amount">${item.amount.toFixed(2)}</td>
                    </tr>
                `;
            });

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${data.type} - ${data.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 0;
                            color: #000000;
                            font-size: 11px;
                            line-height: 1.5;
                        }
                        .print-document {
                            max-width: 100%;
                            margin: 0 auto;
                            position: relative;
                        }
                        .print-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 20px;
                            padding-bottom: 15px;
                        }
                        .print-logo-section {
                            flex: 1;
                        }
                        .print-logo {
                            max-width: 140px;
                            max-height: 90px;
                            object-fit: contain;
                            margin-bottom: 10px;
                        }
                        .print-company-name {
                            font-family: 'Inter', sans-serif;
                            font-size: 18px;
                            font-weight: 400; /* Regular weight */
                            color: #1a3a5f;
                            margin-bottom: 4px;
                        }
                        .print-company-details {
                            font-size: 9px;
                            color: #000000;
                            line-height: 1.4;
                        }
                        .print-company-detail {
                            display: block;
                            margin-bottom: 2px;
                        }
                        .print-document-info {
                            text-align: right;
                            min-width: 200px;
                        }
                        .print-document-type {
                            font-family: 'Inter', sans-serif;
                            font-size: 28px;
                            font-weight: 800;
                            color: #1a3a5f;
                            text-transform: uppercase;
                            letter-spacing: 2px;
                            margin-bottom: 8px;
                        }
                        .print-document-number {
                            font-size: 16px;
                            font-weight: 400; /* Regular weight */
                            color: #1a3a5f;
                            margin-bottom: 4px;
                        }
                        .print-document-date {
                            font-size: 10px;
                            color: #000000;
                        }
                        .print-addresses {
                            display: flex;
                            gap: 40px;
                            margin-bottom: 25px;
                        }
                        .print-address-block {
                            flex: 1;
                            padding: 15px;
                            background: #f9fafb;
                            border-radius: 10px;
                            border: 1px solid #e5e7eb;
                        }
                        .print-address-title {
                            font-weight: 400; /* Regular weight */
                            color: #1a3a5f;
                            margin-bottom: 8px;
                            font-size: 11px;
                            text-transform: uppercase;
                            letter-spacing: 0.8px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }
                        .print-address-title::before {
                            content: '';
                            width: 3px;
                            height: 12px;
                            background: #1a3a5f;
                            border-radius: 2px;
                        }
                        .print-address-line {
                            font-size: 10px;
                            margin-bottom: 3px;
                            color: #000000;
                        }
                        .print-address-line strong {
                            color: #000000;
                            font-weight: 400; /* Regular weight */
                        }
                        .print-items-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 15px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        }
                        .print-items-table th {
                            background: #1a3a5f;
                            color: blac;
                            padding: 10px;
                            text-align: left;
                            font-weight: 400; /* Regular weight */
                            font-size: 10px;
                            text-transform: uppercase;
                            letter-spacing: 0.4px;
                        }
                        .print-items-table td {
                            padding: 8px;
                            border-bottom: 1px solid #e5e7eb;
                            font-size: 9px;
                            vertical-align: top;
                            color: #000000;
                        }
                        .print-items-table tr:nth-child(even) {
                            background: #f9fafb;
                        }
                        .print-items-table .description {
                            font-weight: 400; /* Regular weight */
                            color: #000000;
                            font-size: 10px;
                        }
                        .print-items-table .quantity,
                        .print-items-table .hours {
                            text-align: center;
                            color: #000000;
                            font-weight: 400; /* Regular weight */
                        }
                        .print-items-table .rate,
                        .print-items-table .amount {
                            text-align: right;
                            font-weight: 400; /* Regular weight */
                            color: #000000;
                        }
                        .print-summary {
                            display: flex;
                            gap: 30px;
                            margin-bottom: 25px;
                        }
                        .print-payment-block {
                            flex: 1;
                            padding: 15px;
                            background: #eff6ff;
                            border: 1px solid #bfdbfe;
                            border-radius: 10px;
                            border-left: 3px solid #3b82f6;
                        }
                        .print-payment-title {
                            font-weight: 400; /* Regular weight */
                            color: #1a3a5f;
                            margin-bottom: 8px;
                            font-size: 11px;
                            text-transform: uppercase;
                            letter-spacing: 0.4px;
                        }
                        .print-payment-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 4px;
                            font-size: 9px;
                        }
                        .print-payment-label {
                            color: #000000;
                            font-weight: 400; /* Regular weight */
                        }
                        .print-payment-value {
                            color: #000000;
                            font-weight: 400; /* Regular weight */
                        }
                        .print-totals-block {
                            width: 280px;
                        }
                        .print-totals-table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        .print-totals-table td {
                            padding: 8px;
                            border-bottom: 1px solid #e5e7eb;
                            font-size: 10px;
                        }
                        .print-totals-table .label {
                            color: #000000;
                            font-weight: 400; /* Regular weight */
                        }
                        .print-totals-table .value {
                            text-align: right;
                            color: #000000;
                            font-weight: 400; /* Regular weight */
                        }
                        .print-totals-table .grand-total td {
                            background: #f3f4f6;
                            font-weight: 400; /* Regular weight */
                            color: #1a3a5f;
                            font-size: 11px;
                            border-top: 2px solid #1a3a5f;
                        }
                        .print-footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #e5e7eb;
                            text-align: center;
                            font-size: 9px;
                            color: #000000;
                            font-style: italic;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-document">
                        
                        <div class="print-header">
                            <div class="print-logo-section">
                                ${logoData ? `<img src="${logoData}" alt="Company Logo" class="print-logo">` : ''}
                                <div class="print-company-name">${data.companyInfo.name}</div>
                                <div class="print-company-details">
                                    <span class="print-company-detail">ABN: ${data.companyInfo.abn}</span>
                                    <span class="print-company-detail">Phone: ${data.companyInfo.phone}</span>
                                    <span class="print-company-detail">Email: ${data.companyInfo.email}</span>
                                    ${data.companyInfo.address ? `<span class="print-company-detail">${data.companyInfo.address}</span>` : ''}
                                </div>
                            </div>
                            <div class="print-document-info">
                                <div class="print-document-type">${data.type}</div>
                                <div class="print-document-number">${data.number}</div>
                                <div class="print-document-date">Date: ${data.date}</div>
                            </div>
                        </div>

                        <div class="print-addresses">
                            <div class="print-address-block">
                                <div class="print-address-title">Bill To</div>
                                <div class="print-address-line"><strong>${data.billTo.name}</strong></div>
                                ${data.billTo.company ? `<div class="print-address-line">${data.billTo.company}</div>` : ''}
                                ${data.billTo.email ? `<div class="print-address-line">${data.billTo.email}</div>` : ''}
                                ${data.billTo.mobile ? `<div class="print-address-line">${data.billTo.mobile}</div>` : ''}
                            </div>
                            <div class="print-address-block">
                                <div class="print-address-title">Job Details</div>
                                ${data.jobDetails.address ? `<div class="print-address-line"><strong>Address:</strong> ${data.jobDetails.address}</div>` : ''}
                                ${data.jobDetails.number ? `<div class="print-address-line"><strong>Job Number:</strong> ${data.jobDetails.number}</div>` : ''}
                                ${data.jobDetails.workOrder ? `<div class="print-address-line"><strong>Work Order:</strong> ${data.jobDetails.workOrder}</div>` : ''}
                            </div>
                        </div>

                        <div class="print-items-section">
                            <table class="print-items-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Hours</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHTML}
                                </tbody>
                            </table>
                        </div>

                        <div class="print-summary">
                            <div class="print-payment-block">
                                <div class="print-payment-title">Payment Details</div>
                                <div class="print-payment-row">
                                    <span class="print-payment-label">Bank:</span>
                                    <span class="print-payment-value">${data.bankDetails?.bankName || 'N/A'}</span>
                                </div>
                                <div class="print-payment-row">
                                    <span class="print-payment-label">BSB:</span>
                                    <span class="print-payment-value">${data.bankDetails?.bsb || 'N/A'}</span>
                                </div>
                                <div class="print-payment-row">
                                    <span class="print-payment-label">Account:</span>
                                    <span class="print-payment-value">${data.bankDetails?.account || 'N/A'}</span>
                                </div>
                                <div class="print-payment-row">
                                    <span class="print-payment-label">Account Name:</span>
                                    <span class="print-payment-value">${data.bankDetails?.accountName || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="print-totals-block">
                                <table class="print-totals-table">
                                    <tr>
                                        <td class="label">Subtotal</td>
                                        <td class="value">$${data.subtotal.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">GST (10%)</td>
                                        <td class="value">$${data.gst.toFixed(2)}</td>
                                    </tr>
                                    <tr class="grand-total">
                                        <td class="label">Total</td>
                                        <td class="value">$${data.total.toFixed(2)}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="print-footer">
                            ${appearanceSettings.pdfFooter || 'Thank you for your business!'}
                            ${appearanceSettings.pdfTerms ? `<br><br>${appearanceSettings.pdfTerms}` : ''}
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        // Get document data from form
        function getDocumentDataFromForm() {
            if (!validateDocument()) return null;

            let items = [];
            
            if (isMobileDevice()) {
                // Mobile version
                const itemCards = document.querySelectorAll('.mobile-item-card');
                itemCards.forEach(card => {
                    const description = card.querySelector('.item-description')?.value?.trim() || '';
                    const quantity = parseFloat(card.querySelector('.item-quantity')?.value) || 0;
                    const hours = parseFloat(card.querySelector('.item-hours')?.value) || 0;
                    const rate = parseFloat(card.querySelector('.item-rate')?.value) || 0;
                    const amount = parseFloat(card.querySelector('.item-amount')?.value) || 0;
                    
                    // Safely get image data
                    const imageInput = card.querySelector('.item-image');
                    let imageData = null;
                    if (imageInput && imageInput.dataset) {
                        imageData = imageInput.dataset.imageData || null;
                    }
                    
                    if (description) {
                        items.push({ 
                            description, 
                            quantity, 
                            hours, 
                            rate, 
                            amount,
                            image: imageData
                        });
                    }
                });
            } else {
                // Desktop version
                document.querySelectorAll('.item-row').forEach(row => {
                    const description = row.querySelector('.item-description')?.value?.trim() || '';
                    const quantity = parseFloat(row.querySelector('.item-quantity')?.value) || 0;
                    const hours = parseFloat(row.querySelector('.item-hours')?.value) || 0;
                    const rate = parseFloat(row.querySelector('.item-rate')?.value) || 0;
                    const amount = parseFloat(row.querySelector('.item-amount')?.value) || 0;
                    
                    // Safely get image data
                    const imageInput = row.querySelector('.item-image');
                    let imageData = null;
                    if (imageInput && imageInput.dataset) {
                        imageData = imageInput.dataset.imageData || null;
                    }
                    
                    if (description) {
                        items.push({ 
                            description, 
                            quantity, 
                            hours, 
                            rate, 
                            amount,
                            image: imageData
                        });
                    }
                });
            }

            return {
                type: document.getElementById('documentType')?.value || 'Invoice',
                number: document.getElementById('documentNumber')?.textContent || '',
                date: document.getElementById('documentDate')?.value || '',
                billTo: {
                    name: document.getElementById('clientName')?.value?.trim() || '',
                    company: document.getElementById('companyName')?.value?.trim() || '',
                    email: document.getElementById('clientEmail')?.value?.trim() || '',
                    mobile: document.getElementById('clientMobile')?.value?.trim() || ''
                },
                jobDetails: {
                    address: document.getElementById('jobAddress')?.value?.trim() || '',
                    number: document.getElementById('jobNumber')?.value?.trim() || '',
                    workOrder: document.getElementById('workOrder')?.value?.trim() || ''
                },
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal')?.textContent?.replace('$', '') || 0),
                gst: parseFloat(document.getElementById('gst')?.textContent?.replace('$', '') || 0),
                total: parseFloat(document.getElementById('total')?.textContent?.replace('$', '') || 0),
                bankDetails: {
                    bankName: document.getElementById('bankName')?.value?.trim() || '',
                    bsb: document.getElementById('bsb')?.value?.trim() || '',
                    account: document.getElementById('account')?.value?.trim() || '',
                    accountName: document.getElementById('accountName')?.value?.trim() || 'SMART SQUAD M BUILD PTY LTD',
                    name: bankInfo.name,
                    accountName: bankInfo.accountName
                },
                companyInfo: companyInfo
            };
        }

        // Load documents
        async function loadDocuments() {
            if (!currentUser || currentUser.uid !== ALLOWED_UID) {
                console.log("Not authenticated or wrong user");
                return;
            }

            const invoicesTableBody = document.getElementById('invoicesTableBody');
            const quotationsTableBody = document.getElementById('quotationsTableBody');

            invoicesTableBody.innerHTML = '<tr><td colspan="6" class="loading-message">Loading...</td></tr>';
            quotationsTableBody.innerHTML = '<tr><td colspan="6" class="loading-message">Loading...</td></tr>';

            try {
                if (isOnline) {
                    // If online, load from Firebase
                    console.log("Loading documents from Firebase...");
                    
                    const querySnapshot = await db.collection('quotes')
                        .where('userId', '==', ALLOWED_UID)
                        .orderBy('date', 'desc')
                        .get({ source: 'server' });
                        
                    console.log("Query completed. Found:", querySnapshot.size, "documents");
                    
                    invoicesTableBody.innerHTML = '';
                    quotationsTableBody.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        console.log("No documents found");
                        invoicesTableBody.innerHTML = '<tr><td colspan="6">No invoices found</td></tr>';
                        quotationsTableBody.innerHTML = '<tr><td colspan="6">No quotations found</td></tr>';
                        return;
                    }
                    
                    allDocuments = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log("Document data:", data);
                        
                        allDocuments.push({
                            id: doc.id,
                            data: data
                        });
                    });
                    
                    // Also save to IndexedDB for offline use
                    const transaction = dbInstance.transaction(['documents'], 'readwrite');
                    const store = transaction.objectStore('documents');
                    
                    // Clear existing documents
                    store.clear();
                    
                    // Add all documents from Firebase
                    allDocuments.forEach((doc) => {
                        const documentWithSyncStatus = {
                            ...doc.data,
                            id: doc.id,
                            syncStatus: 'synced',
                            lastModified: new Date().toISOString()
                        };
                        store.put(documentWithSyncStatus);
                    });
                    
                    renderDocuments(allDocuments);
                } else {
                    // If offline, load from IndexedDB
                    console.log("Loading documents from IndexedDB...");
                    
                    const documents = await getDocumentsFromIndexedDB();
                    
                    if (documents.length === 0) {
                        invoicesTableBody.innerHTML = '<tr><td colspan="6">No documents found</td></tr>';
                        quotationsTableBody.innerHTML = '<tr><td colspan="6">No quotations found</td></tr>';
                        return;
                    }
                    
                    allDocuments = documents.map(doc => ({
                        id: doc.id,
                        data: doc
                    }));
                    
                    renderDocuments(allDocuments);
                }
                
                // Update pending sync count
                await updatePendingSyncCount();

            } catch (error) {
                // Don't show errors if user is not logged in (permission errors are expected)
                if (!currentUser || error.code === 'permission-denied') {
                    console.log("Skipping document load - user not authenticated");
                } else {
                    console.error("Error loading documents:", error);
                    
                    if (error.message.includes("The query requires an index")) {
                        const indexUrl = error.message.split("here: ")[1];
                        invoicesTableBody.innerHTML = `<tr><td colspan="6">Database index required. <a href="${indexUrl}" target="_blank">Create Index</a></td></tr>`;
                        quotationsTableBody.innerHTML = `<tr><td colspan="6">Database index required. <a href="${indexUrl}" target="_blank">Create Index</a></td></tr>`;
                        showNotification("Database index required. Please click the link to create it.", "warning");
                    } else {
                        invoicesTableBody.innerHTML = `<tr><td colspan="6">Error loading documents: ${error.message}</td></tr>`;
                        quotationsTableBody.innerHTML = `<tr><td colspan="6">Error loading documents: ${error.message}</td></tr>`;
                        showNotification("Error loading documents: " + error.message, "error");
                    }
                }
            }
        }

        // Render documents in the appropriate table
        function renderDocuments(documents) {
            const invoicesTableBody = document.getElementById('invoicesTableBody');
            const quotationsTableBody = document.getElementById('quotationsTableBody');
            
            invoicesTableBody.innerHTML = '';
            quotationsTableBody.innerHTML = '';
            
            if (documents.length === 0) {
                invoicesTableBody.innerHTML = '<tr><td colspan="6">No invoices found</td></tr>';
                quotationsTableBody.innerHTML = '<tr><td colspan="6">No quotations found</td></tr>';
                return;
            }
            
            documents.forEach((doc) => {
                const data = doc.data;
                const row = document.createElement('tr');
                
                // Add a visual indicator for pending sync
                const syncStatusClass = data.syncStatus === 'pending' ? 'pending-sync' : '';
                const syncIndicator = data.syncStatus === 'pending' ? 
                    '<i class="fas fa-clock" style="color: var(--warning-color);" title="Pending sync"></i>' : '';
                
                row.innerHTML = `
                    <td>${data.type} ${syncIndicator}</td>
                    <td>${data.number}</td>
                    <td>${data.date}</td>
                    <td>${data.billTo.name}</td>
                    <td>$${data.total.toFixed(2)}</td>
                    <td class="actions">
                        <button class="table-action-btn view" data-id="${doc.id}"><i class="fas fa-eye"></i> View</button>
                        <button class="table-action-btn edit" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                        <button class="table-action-btn share" data-id="${doc.id}"><i class="fas fa-share-alt"></i></button>
                        <button class="table-action-btn print" data-id="${doc.id}"><i class="fas fa-print"></i></button>
                        <button class="table-action-btn delete" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;

                if (data.type === 'Invoice') {
                    invoicesTableBody.appendChild(row);
                } else if (data.type === 'Quote') {
                    quotationsTableBody.appendChild(row);
                }

                // Add event listeners
                row.querySelector('.view').addEventListener('click', () => {
                    showDocumentDetails(data, doc.id);
                });

                row.querySelector('.edit').addEventListener('click', () => {
                    editingDocId = doc.id;
                    populateFormWithDocument(data);
                });

                row.querySelector('.share').addEventListener('click', () => {
                    currentDocumentForShare = { data, docId: doc.id };
                    document.getElementById('shareModal').style.display = 'flex';
                });
                
                // Add print button event listener
                row.querySelector('.print').addEventListener('click', () => {
                    printDocument(data);
                });

                row.querySelector('.delete').addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to delete ${data.type} ${data.number}?`)) {
                        try {
                            // Delete from Firebase if online
                            if (isOnline) {
                                await db.collection('quotes').doc(doc.id).delete();
                            }
                            
                            // Delete from IndexedDB
                            const transaction = dbInstance.transaction(['documents'], 'readwrite');
                            const store = transaction.objectStore('documents');
                            store.delete(doc.id);
                            
                            showNotification(`${data.type} ${data.number} deleted successfully!`, "success");
                            await loadUserSequences();
                            loadDocuments();
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            showNotification("Error deleting document. Please try again.", "error");
                        }
                    }
                });
            });
        }

        // Populate form with document data
        function populateFormWithDocument(data) {
            document.getElementById('documentType').value = data.type;
            document.getElementById('documentNumber').textContent = data.number;
            document.getElementById('documentDate').value = data.date;
            document.getElementById('clientName').value = data.billTo.name;
            document.getElementById('companyName').value = data.billTo.company || '';
            document.getElementById('clientEmail').value = data.billTo.email || '';
            document.getElementById('clientMobile').value = data.billTo.mobile || '';
            document.getElementById('jobAddress').value = data.jobDetails.address || '';
            document.getElementById('jobNumber').value = data.jobDetails.number || '';
            document.getElementById('workOrder').value = data.jobDetails.workOrder || '';
            document.getElementById('bankName').value = data.bankDetails?.bankName || '';
            document.getElementById('bsb').value = data.bankDetails?.bsb || '';
            document.getElementById('account').value = data.bankDetails?.account || '';
            document.getElementById('accountName').value = data.bankDetails?.accountName || 'SMART SQUAD M BUILD PTY LTD';

            // Clear and repopulate items
            if (isMobileDevice()) {
                // Mobile version
                const container = document.getElementById('mobileItemsContainer');
                container.innerHTML = '';
                
                data.items.forEach(item => {
                    addMobileItemCard(
                        item.description,
                        item.quantity,
                        item.hours,
                        item.rate,
                        item.amount,
                        item.image
                    );
                });
            } else {
                // Desktop version
                const itemsTableBody = document.getElementById('itemsTableBody');
                itemsTableBody.innerHTML = '';

                data.items.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'item-row';
                    newRow.innerHTML = `
                        <td>
                            <div class="autocomplete-container">
                                <input type="text" class="glass-input large item-description" value="${item.description}" required autocomplete="off">
                                <div class="autocomplete-suggestion"></div>
                                <button class="autocomplete-accept" style="display: none;">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                        <td><input type="number" class="glass-input medium item-quantity" value="${item.quantity}" min="0" step="1"></td>
                        <td><input type="number" class="glass-input medium item-hours" value="${item.hours}" min="0" step="0.5"></td>
                        <td><input type="number" class="glass-input medium-large item-rate" value="${item.rate}" min="0" step="0.01" required></td>
                        <td><input type="text" class="glass-input small item-amount" value="${item.amount.toFixed(2)}" readonly></td>
                        <td><button type="button" class="glass-button remove-item"><i class="fas fa-trash"></i></button></td>
                        <!-- Hidden input for image data -->
                        <input type="hidden" class="item-image">
                    `;
                    itemsTableBody.appendChild(newRow);
                    
                    // Set image data if exists
                    if (item.image) {
                        const imageInput = newRow.querySelector('.item-image');
                        imageInput.dataset.imageData = item.image;
                        
                        // Show image preview
                        const imagePreview = document.createElement('div');
                        imagePreview.className = 'image-attachment';
                        imagePreview.innerHTML = `
                            <img src="${item.image}" class="image-preview" alt="Item image">
                            <div class="image-info">
                                <div>Image attached</div>
                                <button type="button" class="remove-image">Remove</button>
                            </div>
                        `;
                        imageInput.parentNode.parentNode.insertBefore(imagePreview, imageInput.parentNode);
                        
                        // Add remove image functionality
                        imagePreview.querySelector('.remove-image').addEventListener('click', () => {
                            delete imageInput.dataset.imageData;
                            imagePreview.remove();
                        });
                    }
                    
                    enableAutocomplete(newRow.querySelector('.item-description'), newRow.querySelector('.autocomplete-suggestion'), newRow.querySelector('.autocomplete-accept'));
                });
            }

            calculateTotals();
            updatePaymentDetailsDisplay();
            
            // After populating the form, reinitialize autocomplete
            setTimeout(() => {
                initializeAllAutocompletes();
            }, 100);
            
            // Store the populated form as the new original
            storeOriginalFormValues();
        }

        // Show document details
        function showDocumentDetails(data, docId) {
            const modalBody = document.getElementById('detailModalBody');
            let itemsHTML = '<table class="detail-items"><thead><tr><th>Description</th><th>Quantity</th><th>Hours</th><th>Rate ($)</th><th>Amount ($)</th></tr></thead><tbody>';
            data.items.forEach(item => {
                itemsHTML += `<tr><td>${item.description}</td><td>${item.quantity}</td><td>${item.hours}</td><td>${item.rate.toFixed(2)}</td><td>${item.amount.toFixed(2)}</td></tr>`;
            });
            itemsHTML += '</tbody></table>';

            modalBody.innerHTML = `
                <div class="detail-section">
                    <h4><i class="fas fa-file-alt"></i> Document Information</h4>
                    <div class="detail-row">
                        <div class="detail-label">Type:</div>
                        <div class="detail-value">${data.type}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Number:</div>
                        <div class="detail-value">${data.number}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Date:</div>
                        <div class="detail-value">${data.date}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ID:</div>
                        <div class="detail-value">${docId}</div>
                    </div>
                    ${data.syncStatus ? `
                    <div class="detail-row">
                        <div class="detail-label">Sync Status:</div>
                        <div class="detail-value">${data.syncStatus === 'pending' ? '<i class="fas fa-clock" style="color: var(--warning-color);"></i> Pending sync' : '<i class="fas fa-check-circle" style="color: var(--success-color);"></i> Synced'}</div>
                    </div>
                    ` : ''}
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-user"></i> Bill To</h4>
                    <div class="detail-row">
                        <div class="detail-label">Name:</div>
                        <div class="detail-value">${data.billTo.name}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Company:</div>
                        <div class="detail-value">${data.billTo.company || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${data.billTo.email || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Mobile:</div>
                        <div class="detail-value">${data.billTo.mobile || 'N/A'}</div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-briefcase"></i> Job Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Address:</div>
                        <div class="detail-value">${data.jobDetails.address || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Number:</div>
                        <div class="detail-value">${data.jobDetails.number || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Work Order:</div>
                        <div class="detail-value">${data.jobDetails.workOrder || 'N/A'}</div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-list"></i> Items</h4>
                    ${itemsHTML}
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-calculator"></i> Totals</h4>
                    <div class="detail-row">
                        <div class="detail-label">Subtotal:</div>
                        <div class="detail-value">$${data.subtotal.toFixed(2)}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">GST (10%):</div>
                        <div class="detail-value">$${data.gst.toFixed(2)}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Total:</div>
                        <div class="detail-value">$${data.total.toFixed(2)}</div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-credit-card"></i> Payment Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Bank:</div>
                        <div class="detail-value">${data.bankDetails?.bankName || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">BSB:</div>
                        <div class="detail-value">${data.bankDetails?.bsb || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Account:</div>
                        <div class="detail-value">${data.bankDetails?.account || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Account Name:</div>
                        <div class="detail-value">${data.bankDetails?.accountName || 'N/A'}</div>
                    </div>
                </div>
            `;
            document.getElementById('detailModalTitle').textContent = `${data.type} Details - ${data.number}`;
            document.getElementById('documentDetailModal').style.display = 'flex';
            
            // Store current document for PDF generation
            currentDocumentForShare = { data, docId };
        }

        // Update company info header
        function updateCompanyInfoHeader() {
            document.getElementById('companyInfoHeader').innerHTML = `
                <div class="company-name">${companyInfo.name}</div>
                <div class="company-details">ABN ${companyInfo.abn} | Mobile: ${companyInfo.phone}</div>
            `;
        }

        // Update header logo
        function updateHeaderLogo(logoUrl) {
            if (logoUrl) {
                document.querySelector('#appLogo img').src = logoUrl;
            }
        }

       // Classic Dropdown Autocomplete - Modified to support multiple listings
function enableAutocomplete(inputElement, suggestionElement, acceptButton) {
    if (!inputElement || !suggestionElement) {
        console.error("Autocomplete elements not found");
        return;
    }
    
    // Create a dropdown container for suggestions
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'autocomplete-dropdown';
    dropdownContainer.style.position = 'absolute';
    dropdownContainer.style.top = '100%';
    dropdownContainer.style.left = '0';
    dropdownContainer.style.right = '0';
    dropdownContainer.style.zIndex = '100';
    dropdownContainer.style.backgroundColor = 'white';
    dropdownContainer.style.border = '1px solid var(--border-color)';
    dropdownContainer.style.borderTop = 'none';
    dropdownContainer.style.borderRadius = '0 0 var(--border-radius-md) var(--border-radius-md)';
    dropdownContainer.style.maxHeight = '200px';
    dropdownContainer.style.overflowY = 'auto';
    dropdownContainer.style.display = 'none';
    dropdownContainer.style.boxShadow = 'var(--shadow-md)';
    
    // Insert the dropdown after the input container
    const inputContainer = inputElement.closest('.autocomplete-container');
    inputContainer.appendChild(dropdownContainer);
    
    let currentMatches = [];
    let selectedIndex = -1;
    let lastInputValue = '';
    
    // Clear any existing event listeners
    inputElement.removeEventListener('input', handleInput);
    inputElement.removeEventListener('keydown', handleKeydown);
    inputElement.removeEventListener('blur', handleBlur);
    inputElement.removeEventListener('focus', handleFocus);
    
    function handleInput(e) {
        const fullValue = inputElement.value;
        const cursorPosition = inputElement.selectionStart;
        
        // Find the current item being typed (from last comma or start to cursor)
        const beforeCursor = fullValue.substring(0, cursorPosition);
        const lastCommaIndex = beforeCursor.lastIndexOf(',');
        const lastSemicolonIndex = beforeCursor.lastIndexOf(';');
        const lastDelimiterIndex = Math.max(lastCommaIndex, lastSemicolonIndex);
        
        const currentItem = beforeCursor.substring(lastDelimiterIndex + 1).trim();
        const value = currentItem.toLowerCase();
        
        dropdownContainer.innerHTML = '';
        selectedIndex = -1;
        
        // Don't trigger on single character or empty
        if (value.length < 2) {
            dropdownContainer.style.display = 'none';
            return;
        }

        // Get matches with intelligent ranking
        currentMatches = getRankedMatches(value);

        if (currentMatches.length > 0) {
            // Create suggestion items
            currentMatches.forEach((match, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = match.text;
                item.style.padding = '10px 15px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid var(--border-color)';
                
                // Highlight the matching part
                const regex = new RegExp(`(${value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                item.innerHTML = match.text.replace(regex, '<strong>$1</strong>');
                
                // Add hover effect
                item.addEventListener('mouseenter', () => {
                    selectedIndex = index;
                    updateSelection();
                });
                
                // Add click handler
                item.addEventListener('click', () => {
                    // Replace only the current item with the selected suggestion
                    const beforeItem = fullValue.substring(0, lastDelimiterIndex + 1);
                    const afterCursor = fullValue.substring(cursorPosition);
                    
                    // Add the selected item with a comma and space
                    inputElement.value = beforeItem + match.text + ', ' + afterCursor;
                    
                    // Set cursor position after the comma and space
                    const newCursorPosition = beforeItem.length + match.text.length + 2;
                    inputElement.setSelectionRange(newCursorPosition, newCursorPosition);
                    
                    dropdownContainer.style.display = 'none';
                    inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                    inputElement.focus();
                });
                
                dropdownContainer.appendChild(item);
            });
            
            dropdownContainer.style.display = 'block';
        } else {
            dropdownContainer.style.display = 'none';
        }
        
        // Update the last input value
        lastInputValue = value;
    }
    
    function handleKeydown(e) {
        if (dropdownContainer.style.display === 'none') return;
        
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, currentMatches.length - 1);
                updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < currentMatches.length) {
                    // Replace only the current item with the selected suggestion
                    const fullValue = inputElement.value;
                    const cursorPosition = inputElement.selectionStart;
                    
                    const beforeCursor = fullValue.substring(0, cursorPosition);
                    const lastCommaIndex = beforeCursor.lastIndexOf(',');
                    const lastSemicolonIndex = beforeCursor.lastIndexOf(';');
                    const lastDelimiterIndex = Math.max(lastCommaIndex, lastSemicolonIndex);
                    
                    const beforeItem = fullValue.substring(0, lastDelimiterIndex + 1);
                    const afterCursor = fullValue.substring(cursorPosition);
                    
                    // Add the selected item with a comma and space
                    inputElement.value = beforeItem + currentMatches[selectedIndex].text + ', ' + afterCursor;
                    
                    // Set cursor position after the comma and space
                    const newCursorPosition = beforeItem.length + currentMatches[selectedIndex].text.length + 2;
                    inputElement.setSelectionRange(newCursorPosition, newCursorPosition);
                    
                    dropdownContainer.style.display = 'none';
                    inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                }
                break;
            case 'Escape':
                dropdownContainer.style.display = 'none';
                selectedIndex = -1;
                break;
            case ',':
            case ';':
                // When user types a comma or semicolon, hide suggestions temporarily
                dropdownContainer.style.display = 'none';
                // But don't prevent the default behavior
                break;
        }
    }
    
    function updateSelection() {
        const items = dropdownContainer.querySelectorAll('.autocomplete-item');
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = 'var(--bg-light)';
            } else {
                item.style.backgroundColor = 'white';
            }
        });
    }
    
    function handleBlur() {
        // Delay hiding to allow click on suggestion
        setTimeout(() => {
            dropdownContainer.style.display = 'none';
        }, 200);
    }
    
    function handleFocus() {
        // Trigger autocomplete on focus if there's already text
        const fullValue = inputElement.value;
        const cursorPosition = inputElement.selectionStart;
        
        // Find the current item being typed
        const beforeCursor = fullValue.substring(0, cursorPosition);
        const lastCommaIndex = beforeCursor.lastIndexOf(',');
        const lastSemicolonIndex = beforeCursor.lastIndexOf(';');
        const lastDelimiterIndex = Math.max(lastCommaIndex, lastSemicolonIndex);
        
        const currentItem = beforeCursor.substring(lastDelimiterIndex + 1).trim();
        
        if (currentItem.length >= 2) {
            handleInput(new Event('input'));
        }
    }
    
    // Add event listeners
    inputElement.addEventListener('input', handleInput);
    inputElement.addEventListener('keydown', handleKeydown);
    inputElement.addEventListener('blur', handleBlur);
    inputElement.addEventListener('focus', handleFocus);
    
    // Hide the inline suggestion elements
    suggestionElement.style.display = 'none';
    if (acceptButton) {
        acceptButton.style.display = 'none';
    }
}


        // Get ranked matches for autocomplete
        function getRankedMatches(query) {
            const matches = [];
            const queryLower = query.toLowerCase();
            
            // Search through all categories
            Object.entries(autocompleteData).forEach(([category, items]) => {
                items.forEach(item => {
                    const itemLower = item.toLowerCase();
                    
                    // Exact match gets highest priority
                    if (itemLower === queryLower) {
                        matches.push({ text: item, category, score: 100 });
                    }
                    // Starts with query gets high priority
                    else if (itemLower.startsWith(queryLower)) {
                        matches.push({ text: item, category, score: 80 });
                    }
                    // Contains query gets medium priority
                    else if (itemLower.includes(queryLower)) {
                        matches.push({ text: item, category, score: 60 });
                    }
                    // Partial word match gets lower priority
                    else if (queryLower.length >= 2) {
                        const words = itemLower.split(' ');
                        for (const word of words) {
                            if (word.startsWith(queryLower)) {
                                matches.push({ text: item, category, score: 40 });
                                break;
                            }
                        }
                    }
                });
            });
            
            // Sort by score (descending) and then by text (ascending)
            return matches.sort((a, b) => {
                if (a.score !== b.score) {
                    return b.score - a.score;
                }
                return a.text.localeCompare(b.text);
            });
        }

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file type
                if (!file.type.match('image.*')) {
                    showNotification('Please select an image file.', 'error');
                    return;
                }
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image size should be less than 5MB.', 'error');
                    return;
                }
                
                // Read file and store as base64
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = event.target.result;
                    
                    // Store image data in the input element
                    e.target.dataset.imageData = imageData;
                    
                    // Show image preview
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'image-attachment';
                    imagePreview.innerHTML = `
                        <img src="${imageData}" class="image-preview" alt="Item image">
                        <div class="image-info">
                            <div>Image attached</div>
                            <button type="button" class="remove-image">Remove</button>
                        </div>
                    `;
                    e.target.parentNode.parentNode.insertBefore(imagePreview, e.target.parentNode);
                    
                    // Add remove image functionality
                    imagePreview.querySelector('.remove-image').addEventListener('click', () => {
                        delete e.target.dataset.imageData;
                        imagePreview.remove();
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
            container.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Ensure allowed user exists
        async function ensureAllowedUserExists() {
            if (!currentUser || currentUser.uid !== ALLOWED_UID) {
                console.log("Current user is not the allowed UID, skipping user creation");
                return;
            }
            
            try {
                // Try to read from server first for freshest data, but fall back to cache if unavailable
                let userDoc;
                try {
                    userDoc = await db.collection('users').doc(ALLOWED_UID).get({ source: 'server' });
                } catch (srvErr) {
                    console.warn('Server read failed, trying cache:', srvErr && srvErr.message ? srvErr.message : srvErr);
                    userDoc = await db.collection('users').doc(ALLOWED_UID).get({ source: 'default' });
                }

                if (!userDoc.exists) {
                    console.log("Creating authorized user document (with admin flag)...");

                    // Use set with merge true to avoid overwriting if partial data exists
                    await db.collection('users').doc(ALLOWED_UID).set({
                        email: currentUser.email || "authorized@system.com",
                        companyInfo: companyInfo,
                        bankInfo: bankInfo,
                        appearanceSettings: appearanceSettings,
                        nextInvNumber: userSequences.nextInvNumber || 1,
                        nextQotNumber: userSequences.nextQotNumber || 1,
                        isAdmin: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    console.log("Created or merged authorized user document with isAdmin flag");
                } else {
                    // If it exists, ensure isAdmin flag is present
                    const existing = userDoc.data() || {};
                    if (!existing.isAdmin) {
                        try {
                            await db.collection('users').doc(ALLOWED_UID).set({ isAdmin: true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                            console.log('Set isAdmin flag on existing authorized user doc');
                        } catch (setErr) {
                            console.warn('Failed to set isAdmin flag via set(..., {merge:true}):', setErr && setErr.message ? setErr.message : setErr);
                        }
                    }
                    console.log("Authorized user document already exists (ensured admin flag)");
                }
            } catch (error) {
                console.error("Error ensuring allowed user exists (code/message):", error && error.code, error && error.message);
                if (error && (error.code === 'permission-denied' || (error.message && error.message.includes('Missing or insufficient permissions')))) {
                    console.log("Permission error - user might not be authenticated yet or rules not updated");
                    showNotification("Permission error. Please ensure Firebase security rules are updated.", "warning");
                } else {
                    showNotification("Error setting up user data: " + (error && error.message ? error.message : error), "error");
                }
            }
        }

        // Share Functions - Modified to only share PDF files
        function downloadPDF() {
            if (!currentDocumentForShare) return;
            
            const { data } = currentDocumentForShare;
            printDocument(data);
        }
// Share via WhatsApp Function
        // Initialize the application
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize IndexedDB first
            try {
                await initIndexedDB();
                console.log("IndexedDB initialized successfully");
            } catch (error) {
                console.error("Error initializing IndexedDB:", error);
                showNotification("Error initializing offline storage. Some features may not work properly.", "warning");
            }
            
            // Then initialize Firebase
            setTimeout(() => {
                initializeFirebase();
            }, 500);
        });

        // Auth Form Submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const isLogin = document.getElementById('authButtonText').textContent === 'Login';

            if (!email || !password) {
                showNotification('Please enter both email and password', 'warning');
                return;
            }

            const submitBtn = document.getElementById('authSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner"></div> Processing...';

            try {
                if (isLogin) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
                
                // Save login info if remember me is checked
                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                    // Note: We don't save passwords in localStorage for security reasons
                } else {
                    localStorage.removeItem('rememberedEmail');
                }
                
                document.getElementById('authEmail').value = '';
                document.getElementById('authPassword').value = '';
                
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = 'An unknown error occurred.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No user found with this email address. Please create an account or check your email.';
                        break;
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                    case 'auth/internal-error':
                        // Check if the error message contains INVALID_LOGIN_CREDENTIALS
                        if (error.message && error.message.includes('INVALID_LOGIN_CREDENTIALS')) {
                            errorMessage = '❌ Invalid email or password. Please check your credentials and try again.';
                        } else {
                            errorMessage = 'Incorrect password. Please try again.';
                        }
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email address is already in use.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak (minimum 6 characters).';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '🔒 Account temporarily locked due to multiple failed attempts. Please wait 15-30 minutes or reset your password.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    default:
                        errorMessage = error.message || 'Authentication failed. Please try again.';
                }
                
                document.getElementById('authEmailError').textContent = errorMessage;
                document.getElementById('authEmailError').style.display = 'block';
                showNotification(errorMessage, "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Toggle Auth Mode (with null check)
        const toggleAuthModeElement = document.getElementById('toggleAuthMode');
        if (toggleAuthModeElement) {
            toggleAuthModeElement.addEventListener('click', (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('authSubmitBtn');
                const toggleLink = document.getElementById('toggleAuthMode');
                const buttonText = document.getElementById('authButtonText');
                
                if (buttonText.textContent === 'Login') {
                    buttonText.textContent = 'Sign Up';
                toggleLink.textContent = 'Already have an account? Login';
            } else {
                buttonText.textContent = 'Login';
                toggleLink.textContent = 'Need an account? Sign Up';
            }
            
            document.getElementById('authEmailError').style.display = 'none';
        });
        }

        // Forgot Password Link Event Listener
        const forgotPasswordLinkElement = document.getElementById('forgotPasswordLink');
        if (forgotPasswordLinkElement) {
            forgotPasswordLinkElement.addEventListener('click', (e) => {
                e.preventDefault();
                showForgotPasswordModal();
            });
        }

        // Back to Login Link Event Listener
        const backToLoginLinkElement = document.getElementById('backToLoginLink');
        if (backToLoginLinkElement) {
            backToLoginLinkElement.addEventListener('click', (e) => {
                e.preventDefault();
                hideForgotPasswordModal();
            });
        }

        // Close Forgot Password Modal Event Listener
        const closeForgotPasswordModalElement = document.getElementById('closeForgotPasswordModal');
        if (closeForgotPasswordModalElement) {
            closeForgotPasswordModalElement.addEventListener('click', () => {
                hideForgotPasswordModal();
            });
        }

        // Forgot Password Form Submission
        const forgotPasswordFormElement = document.getElementById('forgotPasswordForm');
        if (forgotPasswordFormElement) {
            forgotPasswordFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;

            if (!email) {
                document.getElementById('resetEmailError').textContent = 'Please enter your email address.';
                document.getElementById('resetEmailError').style.display = 'block';
                return;
            }

            const submitBtn = document.getElementById('resetSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner"></div> Sending...';

            // Hide previous messages
            document.getElementById('resetEmailError').style.display = 'none';
            document.getElementById('resetEmailSuccess').style.display = 'none';

            try {
                const result = await sendPasswordReset(email);
                
                if (result.success) {
                    document.getElementById('resetEmailSuccess').textContent = 
                        'Password reset email sent! Check your inbox for instructions.';
                    document.getElementById('resetEmailSuccess').style.display = 'block';
                    document.getElementById('resetEmail').value = '';
                    showNotification('Password reset email sent successfully!', 'success');
                    
                    // Auto-hide modal after 3 seconds
                    setTimeout(() => {
                        hideForgotPasswordModal();
                    }, 3000);
                } else {
                    let errorMessage = 'Failed to send reset email. Please try again.';
                    
                    if (result.error.includes('user-not-found')) {
                        errorMessage = 'No account found with this email address.';
                    } else if (result.error.includes('invalid-email')) {
                        errorMessage = 'Please enter a valid email address.';
                    } else if (result.error.includes('network-request-failed')) {
                        errorMessage = 'Network error. Please check your connection.';
                    }
                    
                    document.getElementById('resetEmailError').textContent = errorMessage;
                    document.getElementById('resetEmailError').style.display = 'block';
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                document.getElementById('resetEmailError').textContent = 'An unexpected error occurred. Please try again.';
                document.getElementById('resetEmailError').style.display = 'block';
                showNotification('An unexpected error occurred. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            });
        }

        // Check for remembered email on page load
        window.addEventListener('DOMContentLoaded', () => {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('authEmail').value = rememberedEmail;
                document.getElementById('rememberMe').checked = true;
            }
        });

        // Save bank details when bank fields change
        document.getElementById('bankName')?.addEventListener('blur', saveBankDetails);
        document.getElementById('bsb')?.addEventListener('blur', saveBankDetails);
        document.getElementById('account')?.addEventListener('blur', saveBankDetails);
        // Account name is static, so we don't save it on blur
        
        // Update payment details display when bank info changes
        document.getElementById('bankName')?.addEventListener('input', updatePaymentDetailsDisplay);
        document.getElementById('bsb')?.addEventListener('input', updatePaymentDetailsDisplay);
        document.getElementById('account')?.addEventListener('input', updatePaymentDetailsDisplay);
        // Account name is static, so we don't update it on input
// --- WhatsApp & SMS Share Logic for Invoice Page ---
// Ensure this code goes after the rest of your DOM is ready

function getInvoiceDetailsForShare() {
    const clientName = document.getElementById('clientName')?.value || '';
    const mobileNumber = document.getElementById('clientMobile')?.value || '';
    const total = document.getElementById('total')?.textContent || '';
    const invoiceNo = document.getElementById('documentNumber')?.textContent || '';
    const invoiceDate = document.getElementById('documentDate')?.value || '';
    // PDF Download Button
    let invoicePDFUrl = '';
    // Try direct PDF button
    const pdfDownloadBtn = document.getElementById('downloadPdfBtn');
    if (pdfDownloadBtn && pdfDownloadBtn.hasAttribute('data-url')) {
        invoicePDFUrl = pdfDownloadBtn.getAttribute('data-url');
    } else if (pdfDownloadBtn && pdfDownloadBtn.href) {
        invoicePDFUrl = pdfDownloadBtn.href;
    } else {
        invoicePDFUrl = window.location.href;
    }

    const shareText =
`SMART SQUAD Invoice
Invoice Number: ${invoiceNo}
Client: ${clientName}
Date: ${invoiceDate}
Total: ${total}
View or download PDF: ${invoicePDFUrl}`;

    return { shareText, mobileNumber };
}

document.getElementById('whatsappShareBtn')?.addEventListener('click', function () {
    const { shareText } = getInvoiceDetailsForShare();
    window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
});

document.getElementById('smsShareBtn')?.addEventListener('click', function () {
    const { shareText, mobileNumber } = getInvoiceDetailsForShare();
    window.open(`sms:${mobileNumber}?body=${encodeURIComponent(shareText)}`);
});

// Enhanced sharing functions that work with document data directly
function shareViaWhatsAppDirect(data) {
    try {
        const message = buildShareMessage(data, data.type?.toLowerCase() || 'document');
        
        // Get client phone number
        const clientPhone = data.billTo?.mobile || data.clientMobile || '';
        
        // Use proper WhatsApp URL scheme for better app integration
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        
        if (isMobile) {
            // For mobile devices, use the WhatsApp app URL scheme with phone number if available
            let whatsappUrl;
            if (clientPhone) {
                // Remove all non-numeric characters and add country code if needed
                const cleanPhone = clientPhone.replace(/\D/g, '');
                const phoneWithCountry = cleanPhone.startsWith('61') ? cleanPhone : `61${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;
                whatsappUrl = `whatsapp://send?phone=${phoneWithCountry}&text=${encodeURIComponent(message)}`;
            } else {
                whatsappUrl = `whatsapp://send?text=${encodeURIComponent(message)}`;
            }
            
            // For iOS, use a different approach
            if (isIOS) {
                // Create a hidden iframe to try opening the app
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = whatsappUrl;
                document.body.appendChild(iframe);
                
                // Remove iframe after attempting to open
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 1000);
                
                // Fallback after delay
                setTimeout(() => {
                    if (clientPhone) {
                        const cleanPhone = clientPhone.replace(/\D/g, '');
                        const phoneWithCountry = cleanPhone.startsWith('61') ? cleanPhone : `61${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;
                        window.open(`https://wa.me/${phoneWithCountry}?text=${encodeURIComponent(message)}`, '_blank');
                    } else {
                        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                    }
                }, 1500);
            } else {
                // For Android, try direct URL change first
                window.location.href = whatsappUrl;
                
                // Fallback to web version after delay
                setTimeout(() => {
                    if (clientPhone) {
                        const cleanPhone = clientPhone.replace(/\D/g, '');
                        const phoneWithCountry = cleanPhone.startsWith('61') ? cleanPhone : `61${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;
                        window.open(`https://wa.me/${phoneWithCountry}?text=${encodeURIComponent(message)}`, '_blank');
                    } else {
                        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                    }
                }, 1500);
            }
        } else {
            // For desktop, use web WhatsApp with phone number if available
            if (clientPhone) {
                const cleanPhone = clientPhone.replace(/\D/g, '');
                const phoneWithCountry = cleanPhone.startsWith('61') ? cleanPhone : `61${cleanPhone.startsWith('0') ? cleanPhone.slice(1) : cleanPhone}`;
                window.open(`https://wa.me/${phoneWithCountry}?text=${encodeURIComponent(message)}`, '_blank');
            } else {
                window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
            }
        }
        
        document.getElementById('shareModal').style.display = 'none';
        showNotification(`Opening WhatsApp to share ${data.type || 'document'}`, 'info');
    } catch (error) {
        console.error('WhatsApp sharing error:', error);
        showNotification(`Error sharing via WhatsApp: ${error.message}`, 'error');
    }
}

function shareViaSMSDirect(data) {
    try {
        const message = buildShareMessage(data, data.type?.toLowerCase() || 'document');
        
        // Get client phone number from the document data
        const clientPhone = data.billTo?.mobile || data.clientMobile || '';
        
        // Create SMS URL that will open the default messages app
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
        
        let smsUrl;
        if (isIOS) {
            // iOS SMS URL scheme
            smsUrl = `sms:${clientPhone}&body=${encodeURIComponent(message)}`;
        } else {
            // Android and other platforms SMS URL scheme
            smsUrl = `sms:${clientPhone}?body=${encodeURIComponent(message)}`;
        }
        
        if (isMobile) {
            // For mobile devices, try multiple approaches for better app opening
            if (isIOS) {
                // iOS approach - use window.location for better app integration
                window.location.href = smsUrl;
            } else {
                // Android approach - use intent URL if available, fallback to sms:
                try {
                    // Try Android intent first
                    const intentUrl = `intent://send?text=${encodeURIComponent(message)}${clientPhone ? `&to=${clientPhone}` : ''}#Intent;scheme=sms;package=com.android.mms;end`;
                    window.location.href = intentUrl;
                } catch (e) {
                    // Fallback to standard SMS URL
                    window.location.href = smsUrl;
                }
            }
        } else {
            // For desktop, create and click a link
            const link = document.createElement('a');
            link.href = smsUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        document.getElementById('shareModal').style.display = 'none';
        
        if (clientPhone) {
            showNotification(`Opening Messages app to send ${data.type || 'document'} to ${clientPhone}`, 'info');
        } else {
            showNotification(`Opening Messages app - please enter recipient manually`, 'info');
        }
    } catch (error) {
        console.error('SMS sharing error:', error);
        showNotification(`Error sharing via SMS: ${error.message}`, 'error');
    }
}

function shareViaEmailDirect(data) {
    try {
        const message = buildShareMessage(data, data.type?.toLowerCase() || 'document');
        
        // Get client email from the document data
        const clientEmail = data.billTo?.email || data.clientEmail || '';
        
        // Create email subject and body
        const companyName = companyInfo.name || 'SMART SQUAD M BUILD PTY LTD';
        const subject = `${data.type || 'Document'} ${data.number || ''} from ${companyName}`;
        const body = `Dear ${data.billTo?.name || data.clientName || 'Client'},\n\n${message}\n\nBest regards,\n${companyName}`;
        
        // Create mailto URL
        const emailUrl = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Create and click a link to trigger email client
        const link = document.createElement('a');
        link.href = emailUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        document.getElementById('shareModal').style.display = 'none';
        
        if (clientEmail) {
            showNotification(`Opening email client to send ${data.type || 'document'} to ${clientEmail}`, 'info');
        } else {
            showNotification(`Opening email client - please enter recipient manually`, 'info');
        }
    } catch (error) {
        console.error('Email sharing error:', error);
        showNotification(`Error sharing via Email: ${error.message}`, 'error');
    }
}

// Proper sharing functions that work with currentDocumentForShare
document.getElementById('shareWhatsapp').addEventListener('click', function() {
    console.log('WhatsApp share clicked', currentDocumentForShare);
    if (currentDocumentForShare && currentDocumentForShare.data) {
        shareViaWhatsAppDirect(currentDocumentForShare.data);
    } else {
        showNotification('Please select a document to share first.', 'warning');
    }
});

document.getElementById('shareSMS').addEventListener('click', function() {
    console.log('SMS share clicked', currentDocumentForShare);
    if (currentDocumentForShare && currentDocumentForShare.data) {
        shareViaSMSDirect(currentDocumentForShare.data);
    } else {
        showNotification('Please select a document to share first.', 'warning');
    }
});

document.getElementById('shareEmail').addEventListener('click', function() {
    console.log('Email share clicked', currentDocumentForShare);
    if (currentDocumentForShare && currentDocumentForShare.data) {
        shareViaEmailDirect(currentDocumentForShare.data);
    } else {
        showNotification('Please select a document to share first.', 'warning');
    }
});


    </script>
</body>
</html>
